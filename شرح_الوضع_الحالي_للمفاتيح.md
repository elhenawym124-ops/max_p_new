# ๐ ุดุฑุญ ุงููุถุน ุงูุญุงูู - ูุธุงู ุงูููุงุชูุญ

## ๐ ุฅุฌุงุจุฉ ุณุคุงูู:

### ุณุคุงู 1: ุงูุดุฑูุฉ ุงูุชู **ููุณ ูุฏููุง ููุงุชูุญ** - ูู ุณุชุณุชุฎุฏู ุงูููุงุชูุญ ุงููุฑูุฒูุฉุ

**ุงูุฌูุงุจ:** โ **ูุนูุ ุณุชุณุชุฎุฏู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ ุชููุงุฆูุงู**

**ุงูููุทู ุงูุญุงูู:**
1. ุงููุธุงู ูุจุญุซ ูู ููุงุชูุญ ุงูุดุฑูุฉ ุฃููุงู
2. ุฅุฐุง ูู ูุฌุฏ **ุฃู** ููุงุชูุญ ุดุฑูุฉ
3. ูุจุญุซ ูู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ ูู **fallback**
4. โ **ูุนูู ุจุดูู ุตุญูุญ**

**ุงูููุฏ (ูู `aiAgentService.js` ุงูุณุทุฑ 5368-5385):**
```javascript
// ุฅุฐุง ูู ุชูุฌุฏ ููุงุชูุญ ุดุฑูุฉ ูุดุทุฉ
if (!activeKey) {
  // ูุญุงููุฉ ุชูุนูู ููุชุงุญ ุดุฑูุฉ
  const autoActivatedKey = await this.findAndActivateFirstAvailableKey(companyId);
  if (autoActivatedKey) {
    return autoActivatedKey;
  }
  
  // โ Fallback: ุงุณุชุฎุฏุงู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ
  if (!useCentralKeys) {
    const centralKey = await this.findActiveCentralKey();
    if (centralKey) {
      return centralKey; // โ ูุณุชุฎุฏู ุงูููุชุงุญ ุงููุฑูุฒู
    }
  }
}
```

---

### ุณุคุงู 2: ุงูุดุฑูุฉ ุงูุชู **ููุงุชูุญูุง ูุณุชููุฐุฉ** - ูู ุณุชุณุชุฎุฏู ุงูููุงุชูุญ ุงููุฑูุฒูุฉุ

**ุงูุฌูุงุจ:** โ **ูุนูุ ุณุชุณุชุฎุฏู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ ุชููุงุฆูุงู**

**ุงูููุทู ุงูุญุงูู:**
1. ุงููุธุงู ูุจุญุซ ุนู ูููุฐุฌ ูุชุงุญ ูู ููุงุชูุญ ุงูุดุฑูุฉ
2. ุฅุฐุง ูุงูุช **ุฌููุน** ุงูููุงุชูุญ ูุณุชููุฐุฉ
3. ูุจุญุซ ูู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ ูู **fallback**
4. โ **ูุนูู ุจุดูู ุตุญูุญ**

**ุงูููุฏ (ูู `aiAgentService.js` ุงูุณุทุฑ 5762-5776):**
```javascript
// ุงูุจุญุซ ุนู ูููุฐุฌ ุงุญุชูุงุทู
const backupModel = await this.findNextAvailableModel(companyId);

// ุฅุฐุง ูู ูุฌุฏ ูู ููุงุชูุญ ุงูุดุฑูุฉ
// โ Fallback: ุงุณุชุฎุฏุงู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ
if (!useCentralKeys) {
  const centralKey = await this.findActiveCentralKey();
  if (centralKey) {
    const nextModelInCentral = await this.findNextModelInKey(centralKey.id);
    if (nextModelInCentral) {
      return {
        apiKey: centralKey.apiKey,
        model: nextModelInCentral.model,
        switchType: 'central_key_fallback' // โ ุงุณุชุฎุฏุงู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ
      };
    }
  }
}
```

---

## ๐ ุฌุฏูู ุงูุญุงูุงุช:

| ุงูุญุงูุฉ | ุงูุดุฑูุฉ ูุฏููุง ููุงุชูุญุ | ุงูููุงุชูุญ ูุณุชููุฐุฉุ | useCentralKeys | ุงููุชูุฌุฉ |
|--------|---------------------|------------------|----------------|---------|
| **1** | โ ูุง | - | false | โ **ูุณุชุฎุฏู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ** (fallback) |
| **2** | โ ูุนู | โ ูุง | false | โ ูุณุชุฎุฏู ููุงุชูุญ ุงูุดุฑูุฉ |
| **3** | โ ูุนู | โ ูุนู (ูููุง) | false | โ **ูุณุชุฎุฏู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ** (fallback) |
| **4** | - | - | true | โ ูุณุชุฎุฏู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ ููุท |

---

## ๐ ููู ูุนูู ุงููุธุงู ุฎุทูุฉ ุจุฎุทูุฉ:

### ุงูุฎุทูุฉ 1: ุงูุจุญุซ ูู ููุงุชูุญ ุงูุดุฑูุฉ
```
if (useCentralKeys = false) {
  โ ุงุจุญุซ ูู ููุงุชูุญ ุงูุดุฑูุฉ
  โ ุฅุฐุง ูุฌุฏุช โ ุงุณุชุฎุฏููุง
  โ ุฅุฐุง ูู ุชุฌุฏ โ ุงูุชูู ููุฎุทูุฉ 2
  โ๏ธ ุฅุฐุง ูุงูุช ูุณุชููุฐุฉ โ ุงูุชูู ููุฎุทูุฉ 2
}
```

### ุงูุฎุทูุฉ 2: Fallback ุฅูู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ
```
if (ูู ุชุฌุฏ ููุงุชูุญ ุดุฑูุฉ ุฃู ูุงูุช ูุณุชููุฐุฉ) {
  โ ุงุจุญุซ ูู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ
  โ ุฅุฐุง ูุฌุฏุช โ ุงุณุชุฎุฏููุง
  โ ุฅุฐุง ูู ุชุฌุฏ โ ูุฑุฌุน null (ุฎุทุฃ)
}
```

---

## โ ุงูุฎูุงุตุฉ:

### โ **ูุนูู ุจุดูู ุตุญูุญ:**

1. โ **ุงูุดุฑูุฉ ุจุฏูู ููุงุชูุญ** โ ุชุณุชุฎุฏู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ ุชููุงุฆูุงู
2. โ **ุงูุดุฑูุฉ ุจููุงุชูุญ ูุณุชููุฐุฉ** โ ุชุณุชุฎุฏู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ ุชููุงุฆูุงู
3. โ **Fallback ุขูู** โ ุฅุฐุง ูู ุชุฌุฏ ูู ููุงุชูุญ ุงูุดุฑูุฉุ ุชุจุญุซ ูู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ

### ๐ ููุงุญุธุฉ:

ุงูุดุฑูุฉ ุงูุชู ูุฏููุง `useCentralKeys = true`:
- ุชุณุชุฎุฏู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ **ููุท**
- ุฅุฐุง ูุงูุช ุงูููุงุชูุญ ุงููุฑูุฒูุฉ ูุณุชููุฐุฉุ ูุง ููุฌุฏ fallback ุญุงููุงู
- (ูุฐุง ููุทูู ูุฃู ุงูุดุฑูุฉ ุงุฎุชุงุฑุช ุงุณุชุฎุฏุงู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ ููุท)

---

## ๐ฏ ุงูุฅุฌุงุจุฉ ุงููุจุงุดุฑุฉ:

**ุณุคุงูู:** ุงูุดุฑูุฉ ุงูุชู ููุณ ูุฏููุง ููุงุชูุญ ุฃู ููุงุชูุญูุง ูุณุชููุฐุฉ - ูู ุณุชุณุชุฎุฏู ุงูููุงุชูุญ ุงููุฑูุฒูุฉุ

**ุงูุฌูุงุจ:** โ **ูุนูุ ุชูุงูุงู!**

ุงููุธุงู ูุตูู ูุงุณุชุฎุฏุงู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ ูู **fallback ุชููุงุฆู** ูู ุงูุญุงูุชูู:
1. โ ุงูุดุฑูุฉ ุจุฏูู ููุงุชูุญ โ ุงูููุงุชูุญ ุงููุฑูุฒูุฉ
2. โ ุงูุดุฑูุฉ ุจููุงุชูุญ ูุณุชููุฐุฉ โ ุงูููุงุชูุญ ุงููุฑูุฒูุฉ

---

**ุงูุชุงุฑูุฎ:** ุงูุขู  
**ุงูุญุงูุฉ:** โ **ุงููุธุงู ูุนูู ุจุดูู ุตุญูุญ ูุน fallback ุชููุงุฆู**

