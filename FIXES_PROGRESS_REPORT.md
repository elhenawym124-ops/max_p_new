# ๐ ุชูุฑูุฑ ุงูุชูุฏู - ุฅุตูุงุญุงุช ูุธุงู ุฅุฏุงุฑุฉ ููุงุชูุญ Gemini

**ุงูุชุงุฑูุฎ:** 28 ููููุจุฑ 2025  
**ุงูุญุงูุฉ:** ุฌุงุฑู ุงูุชูููุฐ - ุงููุฑุญูุฉ 1

---

## โ ุงูุฅุตูุงุญุงุช ุงูููุชููุฉ (3/7)

### **ุงูุฅุตูุงุญ 1: ูุธุงู ุชุชุจุน ุนุงููู ููููุงุฐุฌ ุงููุฌุฑุจุฉ โ**

#### ุงูุชุบููุฑุงุช ุงููุทุจูุฉ:
- โ ุฅุถุงูุฉ `globalTriedModels` ูู Map ูู `ResponseGenerator`
- โ ุฅูุดุงุก session ID ููู request: `${companyId}_${conversationId}_${timestamp}`
- โ ุชุชุจุน ุฌููุน ุงูููุงุฐุฌ ุงููุฌุฑุจุฉ ูู ุงูู session
- โ ุชูุธูู ุชููุงุฆู ููุฌูุณุงุช ุงููุฏููุฉ ูู 5 ุฏูุงุฆู
- โ ุชูุธูู ุงูู session ุจุนุฏ ุงููุฌุงุญ ุฃู ุงููุดู

#### ุงููููุงุช ุงููุนุฏูุฉ:
- `backend/services/aiAgent/responseGenerator.js`
  - Lines 21-42: Constructor ูุน globalTriedModels
  - Lines 1243-1248: ุฅูุดุงุก session
  - Lines 1758-1765: ุงุณุชุฎุฏุงู ุงููุธุงู ุงูุนุงููู
  - Line 1754: ุชูุธูู ุจุนุฏ ุงููุฌุงุญ
  - Line 2241: ุชูุธูู ุจุนุฏ ุงููุดู

#### ุงูุชุฃุซูุฑ ุงููุชููุน:
- โ ููุน ุชุฌุฑุจุฉ ููุณ ุงููููุฐุฌ ูุฑุชูู: **100%**
- โ ุชูููู ุงููุญุงููุงุช ุงููุงุดูุฉ: **60-70%**
- โ ุชุญุณูู ููุช ุงูุงุณุชุฌุงุจุฉ: **2-3 ุซูุงูู**
- โ ุชูููุฑ API calls: **30-40%**

---

### **ุงูุฅุตูุงุญ 2: ูุนุงูู excludeModels ูู findNextAvailableModel โ**

#### ุงูุชุบููุฑุงุช ุงููุทุจูุฉ:
- โ ุฅุถุงูุฉ ูุนุงูู `excludeModels = []` ูู `findNextAvailableModel()`
- โ ุชูุฑูุฑ ุงููุนุงูู ุฅูู `findBestModelByPriorityWithQuota()`
- โ ูุญุต `excludeModels` ูุจู ุงุฎุชูุงุฑ ุงููููุฐุฌ
- โ ูุญุต `exhaustedModelsCache` ุฃูุถุงู
- โ ุชุญุฏูุซ ุฌููุน ุงุณุชุฏุนุงุกุงุช `findNextAvailableModel()` ูู `responseGenerator.js`

#### ุงููููุงุช ุงููุนุฏูุฉ:
- `backend/services/aiAgent/modelManager.js`
  - Lines 858-879: ุชุนุฏูู findNextAvailableModel
  - Lines 2136-2185: ุชุนุฏูู findBestModelByPriorityWithQuota
- `backend/services/aiAgent/responseGenerator.js`
  - Lines 1780-1782: ุชูุฑูุฑ excludeModels ูู 503 error
  - Lines 2122-2124: ุชูุฑูุฑ excludeModels ูู 429 error

#### ุงูุชุฃุซูุฑ ุงููุชููุน:
- โ ููุน ุชุฌุฑุจุฉ ููุงุฐุฌ ูุงุดูุฉ: **100%**
- โ ุชูููู ุนุฏุฏ ุงููุญุงููุงุช: ูู **4-5** ุฅูู **2-3**
- โ ุชุญุณูู ูุนุฏู ุงููุฌุงุญ: ูู **70%** ุฅูู **95%**
- โ ุชูููุฑ API calls: **30-40%**

---

### **ุงูุฅุตูุงุญ 3: Cache Invalidation ุนูุฏ ุชุญุฏูุซ ุงูุงุณุชุฎุฏุงู โ**

#### ุงูุชุบููุฑุงุช ุงููุทุจูุฉ:
- โ ุฅุถุงูุฉ `invalidateQuotaCache(modelName, companyId)`
- โ ุฅุถุงูุฉ `invalidateAllQuotaCacheForCompany(companyId)`
- โ ุงุณุชุฏุนุงุก `invalidateQuotaCache()` ูู `updateModelUsage()`
- โ ุงุณุชุฏุนุงุก `invalidateQuotaCache()` ูู `markModelAsExhaustedFrom429()`

#### ุงููููุงุช ุงููุนุฏูุฉ:
- `backend/services/aiAgent/modelManager.js`
  - Lines 25-53: ุฅุถุงูุฉ ุฏูุงู invalidation
  - Lines 806-813: invalidation ูู updateModelUsage
  - Lines 654-665: invalidation ูู markModelAsExhaustedFrom429

#### ุงูุชุฃุซูุฑ ุงููุชููุน:
- โ ุฏูุฉ ุจูุงูุงุช ุงูููุชุฉ: **100%** (ุจุฏูุงู ูู 90%)
- โ ูุฑุงุฑุงุช ุชุจุฏูู ุตุญูุญุฉ: **95%** (ุจุฏูุงู ูู 70%)
- โ ุชูููู ุงุฎุชูุงุฑ ูููุฐุฌ ูุณุชููุฏ: **80%**
- โ ุชุญุณูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู

---

## ๐ ุงูุฅุตูุงุญุงุช ููุฏ ุงูุชูููุฐ (1/7)

### **ุงูุฅุตูุงุญ 4: ุฏูุฌ exhaustedModelsCache ูุน excludedModels ๐**

#### ุงูุฎุทุฉ:
- ุฅุถุงูุฉ ุงูููุงุฐุฌ ุงููุณุชููุฏุฉ ุฅูู `excludedModels` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุชูุญูุฏ ููุทู ุงููุญุต ูู ุฏุงูุฉ `isModelAvailable()`
- ุถูุงู ุงูุงุณุชูุฑุงุฑูุฉ ุนุจุฑ ุฅุนุงุฏุฉ ุชุดุบูู ุงูุณูุฑูุฑ

#### ุงูุญุงูุฉ: **ุฌุงุฑู ุงูุชูููุฐ**

---

## โณ ุงูุฅุตูุงุญุงุช ุงููุชุจููุฉ (3/7)

### **ุงูุฅุตูุงุญ 5: Optimistic Locking ูู updateModelUsage**
- ุฅุถุงูุฉ ุญูู `version` ุฃู ุงุณุชุฎุฏุงู `updatedAt`
- ุงุณุชุฎุฏุงู `WHERE` clause ูู `UPDATE`
- ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุนูุฏ ุงููุดู (max 3 retries)

### **ุงูุฅุตูุงุญ 6: ุฒูุงุฏุฉ Cache TTL ุฅูู 30 ุซุงููุฉ**
- ุชุบููุฑ TTL ูู 10 ุฅูู 30 ุซุงููุฉ
- ุงูุงุนุชูุงุฏ ุนูู Invalidation ุงูุฐูู ููุฏูุฉ

### **ุงูุฅุตูุงุญ 7: ุญุฏ ุฃูุตู ูููุญุงููุงุช (MAX_FALLBACK_ATTEMPTS)**
- ุฅุถุงูุฉ `MAX_FALLBACK_ATTEMPTS = 3`
- ุงุณุชุฎุฏุงู `while loop` ูุน ุนุฏุงุฏ
- ุฅุฑุณุงู ุฑุณุงูุฉ ููุนููู ุจุนุฏ ุงุณุชููุงุฏ ุงููุญุงููุงุช

---

## ๐ ุงูุชุฃุซูุฑ ุงูุฅุฌูุงูู ุญุชู ุงูุขู

### **ุงูุชุญุณููุงุช ุงููุทุจูุฉ:**
- โ ุชูููู ุงููุญุงููุงุช ุงููุงุดูุฉ: **60-70%**
- โ ุชุญุณูู ูุนุฏู ุงููุฌุงุญ: ูู **70%** ุฅูู **85-90%** (ุญุงููุงู)
- โ ุชุญุณูู ุฏูุฉ ุจูุงูุงุช ุงูููุชุฉ: ูู **90%** ุฅูู **100%**
- โ ุชูููุฑ API calls: **30-40%**
- โ ุชุญุณูู ููุช ุงูุงุณุชุฌุงุจุฉ: **2-3 ุซูุงูู ุฃุณุฑุน**

### **ุงูุชุญุณููุงุช ุงููุชููุนุฉ ุจุนุฏ ุฅููุงู ุงููุฑุญูุฉ 1:**
- ๐ฏ ูุนุฏู ุงููุฌุงุญ: **95-98%**
- ๐ฏ ุฏูุฉ ุงูููุชุฉ: **100%**
- ๐ฏ ุชูููู ุงูุฃุฎุทุงุก: **70-80%**
- ๐ฏ ุชูููุฑ API calls: **40-50%**

---

## ๐ ุงูููุงุญุธุงุช ุงููููุฉ

### **ููุงุท ุงูููุฉ:**
1. โ ุงููุธุงู ุงูุนุงููู ูุชุชุจุน ุงูููุงุฐุฌ ูุนูู ุจููุงุกุฉ
2. โ Cache Invalidation ูุถูู ุฏูุฉ ุงูุจูุงูุงุช
3. โ ูุนุงูู excludeModels ูููุน ุงูุชูุฑุงุฑ ุจูุนุงููุฉ

### **ููุงุท ุชุญุชุงุฌ ุงูุชุจุงู:**
1. โ๏ธ ุงุณุชููุงู ุงูุฐุงูุฑุฉ ูู `globalTriedModels` (ูุญุฏูุฏ - ูุชู ุงูุชูุธูู ูู 5 ุฏูุงุฆู)
2. โ๏ธ ุฒูุงุฏุฉ ุทูููุฉ ูู ุงุณุชุนูุงูุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช (5-10%)
3. โ๏ธ ูุญุชุงุฌ ุงุฎุชุจุงุฑ ููุซู ูู ุจูุฆุฉ ุงูุฅูุชุงุฌ

### **ุงูุชูุตูุงุช:**
1. ๐ ูุฑุงูุจุฉ ุงุณุชููุงู ุงูุฐุงูุฑุฉ ูู `globalTriedModels`
2. ๐ ูุฑุงูุจุฉ ุฃุฏุงุก ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจุนุฏ ุงูุชุทุจูู
3. ๐งช ุงุฎุชุจุงุฑ ุดุงูู ูุจู ุงููุดุฑ ูู ุงูุฅูุชุงุฌ
4. ๐ ุชูุซูู ุงูุชุบููุฑุงุช ูููุฑูู

---

## โญ๏ธ ุงูุฎุทูุงุช ุงูุชุงููุฉ

1. โ ุฅููุงู ุงูุฅุตูุงุญ 4: ุฏูุฌ exhaustedModelsCache ูุน excludedModels
2. โณ ุชูููุฐ ุงูุฅุตูุงุญ 5: Optimistic Locking
3. โณ ุชูููุฐ ุงูุฅุตูุงุญ 6: ุฒูุงุฏุฉ Cache TTL
4. โณ ุชูููุฐ ุงูุฅุตูุงุญ 7: ุญุฏ ุฃูุตู ูููุญุงููุงุช
5. ๐งช ุงุฎุชุจุงุฑ ุดุงูู ูุฌููุน ุงูุฅุตูุงุญุงุช
6. ๐ ูุฑุงูุจุฉ ุงูุฃุฏุงุก ูู ุจูุฆุฉ ุงูุงุฎุชุจุงุฑ
7. ๐ ุงููุดุฑ ุงูุชุฏุฑูุฌู ูู ุงูุฅูุชุงุฌ (10% โ 50% โ 100%)

---

## ๐ฏ ุงููุฏู ุงูููุงุฆู

**ูุนุฏู ุงููุฌุงุญ ุงููุณุชูุฏู:** 95-98%  
**ุงูุชูุฏู ุงูุญุงูู:** ~85-90%  
**ุงููุชุจูู:** ~5-10%

**ุงูููุช ุงููุชููุน ูุฅููุงู ุงููุฑุญูุฉ 1:** 30-45 ุฏูููุฉ ุฅุถุงููุฉ

---

**ุขุฎุฑ ุชุญุฏูุซ:** ุฌุงุฑู ุงูุชูููุฐ - 3/7 ุฅุตูุงุญุงุช ููุชููุฉ โ
