# โ ุชูููุฐ ูุธุงู ุชุฌููุน ุงูููุชุฉ ูRound-Robin

## ๐ ููุฎุต ุงูุชูููุฐ

ุชู ุชูููุฐ ูุธุงู ุฐูู ูุชุฌููุน ุงูููุชุฉ ูู ูู ุงูููุงุชูุญ ูุชูุฒูุน ุงูุทูุจุงุช ุจุงุณุชุฎุฏุงู Round-Robin ูุน ุงูุชุจุฏูู ุงูุชููุงุฆู ุนูุฏ 80% ูุงุณุชุซูุงุก ุงูููุงุฐุฌ ุงููุณุชููุฏุฉ.

## โ ุงููููุงุช ุงููุนุฏูุฉ

### 1. `backend/prisma/schema.prisma`
- โ ุฅุถุงูุฉ `ExcludedModel` table ูุชุชุจุน ุงูููุงุฐุฌ ุงููุณุชุซูุงุฉ

### 2. `backend/services/aiAgent/modelManager.js`
- โ ุฅุถุงูุฉ `quotaCache` ูุน TTL 10 ุซูุงูู
- โ ุฅุถุงูุฉ `lastUsedGlobalKeyId` ูุชุชุจุน ุขุฎุฑ ููุชุงุญ ูุณุชุฎุฏู (Global)
- โ ุฅุถุงูุฉ `excludedModels` Map ููุฐุงูุฑุฉ ุงููุคูุชุฉ
- โ ุฅุถุงูุฉ `aggregateModelsByPriority` ูุชุฌููุน ุงูููุงุฐุฌ ูู ูู ุงูููุงุชูุญ
- โ ุฅุถุงูุฉ `calculateTotalQuota` ูุญุณุงุจ ุงูููุชุฉ ุงูุฅุฌูุงููุฉ ูุน Caching
- โ ุฅุถุงูุฉ `selectNextKeyRoundRobin` ูุน Optimistic Locking
- โ ุฅุถุงูุฉ `excludeModel` ู `isModelExcluded` ูุฅุฏุงุฑุฉ ุงูููุงุฐุฌ ุงููุณุชุซูุงุฉ
- โ ุฅุถุงูุฉ `checkAndRetryExcludedModels` ููุชุญูู ูู ุงูููุงุฐุฌ ุงููุณุชุซูุงุฉ ูุฅุนุงุฏุฉ ุงููุญุงููุฉ
- โ ุฅุถุงูุฉ `findBestModelByPriorityWithQuota` ูุงุฎุชูุงุฑ ุฃูุถู ูููุฐุฌ ุจูุงุกู ุนูู ุงูุฃููููุฉ ูุงูููุชุฉ
- โ ุชุนุฏูู `getActiveGeminiKeyWithModel` ูุงุณุชุฎุฏุงู ุงููุธุงู ุงูุฌุฏูุฏ ูุน fallback
- โ ุชุนุฏูู `findNextAvailableModel` ูุงุณุชุฎุฏุงู ุงููุธุงู ุงูุฌุฏูุฏ

### 3. `backend/server.js`
- โ ุฅุถุงูุฉ Background Job ูู `checkAndRetryExcludedModels` (ูู ุณุงุนุฉ)

## ๐ฏ ุงูููุฒุงุช ุงููุถุงูุฉ

### 1. ุชุฌููุน ุงูููุชุฉ (Quota Aggregation)
- ุชุฌููุน RPM/TPM/RPD ูู ูู ุงูููุงุชูุญ ุงููุชุงุญุฉ
- ุญุณุงุจ ุงููุณุจ ุงููุฆููุฉ ููุงุณุชุฎุฏุงู
- Caching ููุฏุฉ 10 ุซูุงูู ูุชุญุณูู ุงูุฃุฏุงุก

### 2. Round-Robin ุนูู ุงูููุงุชูุญ
- ุชูุฒูุน ุงูุทูุจุงุช ุนูู ุงูููุงุชูุญ ุจุดูู ุนุงุฏู
- ุชุชุจุน ุขุฎุฑ ููุชุงุญ ูุณุชุฎุฏู (Global)
- Optimistic Locking ูุชุฌูุจ Race Conditions

### 3. ุงูุชุจุฏูู ุงูุชููุงุฆู ุนูุฏ 80%
- ุงูุชุจุฏูู ุงูุชููุงุฆู ูููููุฐุฌ ุงูุชุงูู ุนูุฏ ูุตูู RPM/TPM ุฅูู 80%
- ูุญุต RPD ูุงุณุชุซูุงุก ุงูููุงุฐุฌ ุงููุณุชููุฏุฉ (100%)

### 4. ุงุณุชุซูุงุก ุงูููุงุฐุฌ ุงููุณุชููุฏุฉ
- ุงุณุชุซูุงุก ุงูููุงุฐุฌ ุงูุชู ุงุณุชููุฏุช RPD
- ุฅุนุงุฏุฉ ุงููุญุงููุฉ ูู 6 ุณุงุนุงุชุ ุซู 3 ุณุงุนุงุชุ ุซู ูุน ุงูููู ุงูุฌุฏูุฏ
- Background Job ููุชุญูู ูู ุงูููุงุฐุฌ ุงููุณุชุซูุงุฉ ูู ุณุงุนุฉ

## ๐ ุขููุฉ ุงูุนูู

### ุนูุฏ ุทูุจ ูููุฐุฌ:
1. `getActiveGeminiKeyWithModel` โ `findBestModelByPriorityWithQuota`
2. ุชุฌููุน ุงูููุงุฐุฌ ูู ูู ุงูููุงุชูุญ (ูููุตูุฉ: ุดุฑูุฉ vs ูุฑูุฒูุฉ)
3. ุญุณุงุจ ุงูููุชุฉ ุงูุฅุฌูุงููุฉ (ูุน Cache 10 ุซูุงูู)
4. ูุญุต 80% โ ุฅุฐุง ุชุฌุงูุฒ โ ุชุฎุทู ูููููุฐุฌ ุงูุชุงูู
5. ูุญุต RPD โ ุฅุฐุง 100% โ ุงุณุชุซูุงุก
6. Round-Robin ุนูู ุงูููุงุชูุญ ุงููุชุงุญุฉ
7. ุชุญุฏูุซ `lastUsedGlobalKeyId`

### ูู ุฏูููุฉ (ุชููุงุฆูุงู):
- ุชุฌุฏูุฏ RPM/TPM ุชููุงุฆูุงู (ููุฌูุฏ ุจุงููุนู ูู `findBestAvailableModelInActiveKey`)

### ูู ุณุงุนุฉ (Background Job):
- `checkAndRetryExcludedModels` ููุชุญูู ูู ุงูููุงุฐุฌ ุงููุณุชุซูุงุฉ

## ๐ง ุงูุฎุทูุฉ ุงูุชุงููุฉ ุงููุทููุจุฉ

### ุฅูุดุงุก Migration:
```bash
cd backend
npx prisma migrate dev --name add_excluded_model_table
```

ุฃู ูุฏููุงู:
```sql
CREATE TABLE excluded_models (
  id VARCHAR(255) PRIMARY KEY,
  modelName VARCHAR(255) NOT NULL,
  keyId VARCHAR(255),
  companyId VARCHAR(255),
  reason VARCHAR(50) NOT NULL,
  excludedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  retryAt DATETIME NOT NULL,
  retryCount INT DEFAULT 0,
  lastRetryAt DATETIME,
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_model_key (modelName, keyId),
  INDEX idx_retry_at (retryAt),
  INDEX idx_company_id (companyId)
);
```

## โ ุงูุงุฎุชุจุงุฑ

ุจุนุฏ ุฅูุดุงุก Migrationุ ูููู ุงุฎุชุจุงุฑ ุงููุธุงู:

1. **ุงุฎุชุจุงุฑ ุชุฌููุน ุงูููุชุฉ**: ุงูุชุญูู ูู ุญุณุงุจ ุงูููุชุฉ ุงูุฅุฌูุงููุฉ ูู 10 ููุงุชูุญ
2. **ุงุฎุชุจุงุฑ Round-Robin**: ุงูุชุญูู ูู ุงูุชูุฒูุน ุงูุนุงุฏู ุนูู ุงูููุงุชูุญ
3. **ุงุฎุชุจุงุฑ ุงูุชุจุฏูู ุนูุฏ 80%**: ูุญุงูุงุฉ ุงุณุชุฎุฏุงู 80% ูู ุงูููุชุฉ
4. **ุงุฎุชุจุงุฑ ุงุณุชุซูุงุก ุงูููุงุฐุฌ**: ูุญุงูุงุฉ ุงุณุชููุงุฏ RPD
5. **ุงุฎุชุจุงุฑ ุฅุนุงุฏุฉ ุงููุญุงููุฉ**: ุงูุชุญูู ูู ุฅุนุงุฏุฉ ุงููุญุงููุฉ (6 ุณุงุนุงุชุ 3 ุณุงุนุงุชุ ุงูููู ุงูุชุงูู)
6. **ุงุฎุชุจุงุฑ Caching**: ุงูุชุญูู ูู ุงูุชุญุฏูุซ ูู 10 ุซูุงูู
7. **ุงุฎุชุจุงุฑ Optimistic Locking**: ูุญุงูุงุฉ ุทูุจุงุช ูุชุฒุงููุฉ

## ๐ ููุงุญุธุงุช ูููุฉ

- ุงููุธุงู ุงูุฌุฏูุฏ ูุนูู ุฌูุจุงู ุฅูู ุฌูุจ ูุน ุงููุธุงู ุงููุฏูู (fallback)
- ููุงุชูุญ ุงูุดุฑูุฉ ูููุตูุฉ ุนู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ (ูุง ุชุฌููุน ุจููููุง)
- Round-Robin Global (ุขุฎุฑ ููุชุงุญ ุงุณุชุฎุฏูุชู ุงููุธุงู ููู)
- Caching 10 ุซูุงูู (ุชูุงุฒู ุจูู ุงูุฃุฏุงุก ูุงูุฏูุฉ)
- Optimistic Locking (ุชุฌูุจ Race Conditions)

