# โ ููุฎุต ุชูููุฐ ุชุชุจุน TPM (Tokens Per Minute)

## ๐ ุงูุชุบููุฑุงุช ุงููููุฐุฉ:

### 1. **ุชุญุฏูุซ `updateModelUsage` ูู `modelManager.js`**:
   - โ ุฅุถุงูุฉ ูุนุงูู `totalTokenCount` (ุงุฎุชูุงุฑูุ ุงูุชุฑุงุถู = 0)
   - โ ุฅุถุงูุฉ ุชุชุจุน TPM ูุน ูุงูุฐุฉ ุฒูููุฉ (60 ุซุงููุฉ)
   - โ ุงุณุชุฎุฏุงู ุงูููู ุงูุงูุชุฑุงุถูุฉ ูู `getModelDefaults` ูู TPM limit
   - โ ุชุญุฏูุซ TPM ูู ููุณ ุงูููุช ูุน RPM, RPH, RPD

### 2. **ุชุญุฏูุซ `findBestAvailableModelInActiveKey` ูู `modelManager.js`**:
   - โ ุฅุถุงูุฉ ูุญุต TPM ูุจู ุงุณุชุฎุฏุงู ุงููููุฐุฌ
   - โ ุชุฎุทู ุงููููุฐุฌ ุฅุฐุง ุชุฌุงูุฒ TPM limit
   - โ ุฅุนุงุฏุฉ ุชุนููู TPM ุชููุงุฆูุงู ุจุนุฏ ูุฑูุฑ ุฏูููุฉ

### 3. **ุชุญุฏูุซ `responseGenerator.js`**:
   - โ ุงุณุชุฎุฑุงุฌ `totalTokenCount` ูู `usageMetadata`
   - โ ุชูุฑูุฑ `totalTokenCount` ุฅูู `updateModelUsage`
   - โ ุชุญุฏูุซ ุฌููุน ุงุณุชุฏุนุงุกุงุช `updateModelUsage` ูุชูุฑูุฑ tokens

### 4. **ุชุญุฏูุซ `aiAgentService.js`**:
   - โ ุชุญุฏูุซ `updateModelUsage` ูุงุณุชุฎุฏุงู `modelManager` (delegation)
   - โ ุฅุถุงูุฉ ูุนุงูู `totalTokenCount` ููุชูุงูู

### 5. **ุชุญุฏูุซ `getModelDefaults`**:
   - โ ุฅุถุงูุฉ `tpm` ูู ุงูููู ุงูุงูุชุฑุงุถูุฉ ูุฌููุน ุงูููุงุฐุฌ
   - โ ุงูููู ูู ุงูุตูุฑุฉ ุงููุนููุฉ:
     - `gemini-2.5-pro`: 125,000
     - `gemini-2.5-flash`: 250,000
     - `gemini-2.0-flash-lite`: 1,000,000
     - `gemini-2.0-flash`: 1,000,000
     - `gemini-2.5-flash-lite`: 250,000
     - `gemini-robotics-er-1.5-preview`: 250,000
     - `learnlm-2.0-flash-experimental`: null (N/A)

## ๐ ููู ูุนูู:

### 1. **ุนูุฏ ุชุญุฏูุซ ุงูุงุณุชุฎุฏุงู**:
```javascript
await updateModelUsage(modelId, totalTokenCount);
```

- ูุชู ุชุญุฏูุซ TPM ุจูุงุกู ุนูู `totalTokenCount` ูู `usageMetadata`
- ุฅุฐุง ูุงูุช ุงููุงูุฐุฉ ุงูุฒูููุฉ (60 ุซุงููุฉ) ุงูุชูุชุ ูุจุฏุฃ ูู ุงูุตูุฑ
- ุฅุฐุง ูุงูุช ุงููุงูุฐุฉ ูุง ุชุฒุงู ูุดุทุฉุ ูุถูู ููุนุฏุฏ ุงูุญุงูู

### 2. **ุนูุฏ ูุญุต ุงููููุฐุฌ**:
```javascript
if (usage.tpm.used >= usage.tpm.limit) {
  // ุชุฎุทู ุงููููุฐุฌ - ุชุฌุงูุฒ TPM
  continue;
}
```

- ูุชู ูุญุต TPM ูุจู ุงุณุชุฎุฏุงู ุงููููุฐุฌ
- ุฅุฐุง ุชุฌุงูุฒ ุงูุญุฏุ ูุชู ุชุฎุทู ุงููููุฐุฌ ูุงูุจุญุซ ุนู ุขุฎุฑ

### 3. **ุฅุนุงุฏุฉ ุงูุชุนููู ุงูุชููุงุฆู**:
- ุจุนุฏ ูุฑูุฑ 60 ุซุงููุฉุ ูุชู ุฅุนุงุฏุฉ ุชุนููู TPM ุชููุงุฆูุงู
- ุงููุงูุฐุฉ ุงูุฒูููุฉ ุชุจุฏุฃ ูู ุฌุฏูุฏ

## ๐ ุงูุจูุงูุงุช ุงููุฎุฒูุฉ:

```json
{
  "rpm": { "used": 1, "limit": 2, "windowStart": "2025-01-XX..." },
  "rph": { "used": 1, "limit": 120, "windowStart": "2025-01-XX..." },
  "rpd": { "used": 1, "limit": 50, "windowStart": "2025-01-XX..." },
  "tpm": { "used": 1000, "limit": 125000, "windowStart": "2025-01-XX..." }
}
```

## โ ุงูุงุฎุชุจุงุฑ:

ุชู ุฅูุดุงุก ููู ุงุฎุชุจุงุฑ: `backend/scripts/testTPMTracking.js`

ูุชุดุบูู ุงูุงุฎุชุจุงุฑ:
```bash
node backend/scripts/testTPMTracking.js
```

## ๐ฏ ุงูุฎุทูุงุช ุงูุชุงููุฉ:

1. โ ุชุชุจุน TPM (ุชู)
2. โณ ุงุฎุชุจุงุฑ ุงูุชุชุจุน
3. โณ ููุงูุดุฉ ุญู ูุดููุฉ ุงูููุชุฉ ูุงูุชุจุฏูู

## ๐ ููุงุญุธุงุช:

- โ TPM ูุนูู ุจุดูู ูุดุงุจู ูู RPM (ูุงูุฐุฉ ุฒูููุฉ 60 ุซุงููุฉ)
- โ ูุณุชุฎุฏู `usageMetadata.totalTokenCount` ูู ุงูุฑุฏ ุงููุนูู (ุฏููู 100%)
- โ ูุชู ูุญุต TPM ูุจู ุงุณุชุฎุฏุงู ุงููููุฐุฌ (ูุซู RPM, RPH, RPD)
- โ ุฅุนุงุฏุฉ ุงูุชุนููู ุงูุชููุงุฆู ุจุนุฏ ูุฑูุฑ 60 ุซุงููุฉ

