# ๐ ุชุญููู ุงุณุชุฎุฏุงู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ ูู ุจูุงุก ุงูุฑุฏ

**ุชุงุฑูุฎ ุงูุชุญููู:** 2025-11-28  
**ุงููุฏู:** ุงูุชุฃูุฏ ูู ุฃู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ ุชูุณุชุฎุฏู ูู ุฌููุน ุงููุณุงุฑุงุช ุงูุชู ุชุจูู ุงูุฑุฏ

---

## โ ุงููุณุงุฑุงุช ุงูุชู ุชุณุชุฎุฏู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ

### 1. ุงููุณุงุฑ ุงูุฑุฆูุณู - `buildAdvancedPrompt` โ

**ุงููููุน:** `backend/services/aiAgent/responseGenerator.js` - ุงูุณุทุฑ 294  
**ุงูุงุณุชุฎุฏุงู:** `backend/services/aiAgent/messageProcessor.js` - ุงูุณุทุฑ 761

**ุงูุญุงูุฉ:** โ **ูุณุชุฎุฏู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ**

```javascript
// โ FIX: ุฅุถุงูุฉ ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ (Response Rules Checkpoints) - ููู ุฌุฏุงู!
console.log('๐ [RESPONSE-RULES] Checking for response rules...');
if (companyPrompts.responseRules) {
  try {
    const rules = typeof companyPrompts.responseRules === 'string' 
      ? JSON.parse(companyPrompts.responseRules) 
      : companyPrompts.responseRules;
    const rulesPrompt = buildPromptFromRules(rules);
    prompt += rulesPrompt;
  } catch (e) {
    // ุงุณุชุฎุฏุงู ุงูููุงุนุฏ ุงูุงูุชุฑุงุถูุฉ ูู ุญุงูุฉ ุงูุฎุทุฃ
    prompt += buildPromptFromRules(getDefaultRules());
  }
} else {
  // ุงุณุชุฎุฏุงู ุงูููุงุนุฏ ุงูุงูุชุฑุงุถูุฉ ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ
  prompt += buildPromptFromRules(getDefaultRules());
}
```

**ุงูุชุฃุซูุฑ:** โ ุฌููุน ุงูุฑุฏูุฏ ุงูุนุงุฏูุฉ ุชุณุชุฎุฏู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ

---

### 2. ุงููุณุงุฑ ุงูุฃุณุงุณู - `buildPrompt` โ

**ุงููููุน:** `backend/services/aiAgent/responseGenerator.js` - ุงูุณุทุฑ 136  
**ุงูุงุณุชุฎุฏุงู:** `backend/services/aiAgent/messageProcessor.js` - ุงูุณุทุฑ 1614

**ุงูุญุงูุฉ:** โ **ูุณุชุฎุฏู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ**

```javascript
// โ ุฅุถุงูุฉ ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ (Response Rules Checkpoints)
if (companyPrompts.responseRules) {
  try {
    const rules = typeof companyPrompts.responseRules === 'string' 
      ? JSON.parse(companyPrompts.responseRules) 
      : companyPrompts.responseRules;
    prompt += buildPromptFromRules(rules);
  } catch (e) {
    prompt += buildPromptFromRules(getDefaultRules());
  }
} else {
  prompt += buildPromptFromRules(getDefaultRules());
}
```

**ุงูุชุฃุซูุฑ:** โ ุงููุณุงุฑ ุงูุจุฏูู (Pattern Application) ูุณุชุฎุฏู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ

---

### 3. ูุณุงุฑ Retry - `buildAdvancedPrompt` โ (ุชู ุฅุตูุงุญู)

**ุงููููุน:** `backend/services/aiAgent/messageProcessor.js` - ุงูุณุทุฑ 928-1014

**ุงูุญุงูุฉ:** โ **ูุณุชุฎุฏู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ** (ุชู ุฅุตูุงุญู)

**ูุจู ุงูุฅุตูุงุญ:**
- โ ูุงู ูุณุชุฎุฏู prompt ุจุณูุท ุจุฏูู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ
- โ ุงูุฑุฏูุฏ ูู retry ูุง ุชุชุจุน ุงูููุงุนุฏ ุงููุฎุชุงุฑุฉ

**ุจุนุฏ ุงูุฅุตูุงุญ:**
```javascript
// โ FIX: ุงุณุชุฎุฏุงู buildAdvancedPrompt ูู retry ูุถูุงู ุงุณุชุฎุฏุงู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ
const retryPrompt = await this.aiAgentService.buildAdvancedPrompt(
  content,
  customerData,
  companyPrompts,
  ragData,
  conversationMemory,
  hasImages,
  smartResponse,
  {
    ...messageData,
    isRetry: true
  }
);
```

**ุงูุชุฃุซูุฑ:** โ ุงูุฑุฏูุฏ ูู retry ุชุณุชุฎุฏู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ

---

## ๐ ููุฎุต

### โ ุงููุณุงุฑุงุช ุงูุชู ุชุณุชุฎุฏู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ:

1. **ุงููุณุงุฑ ุงูุฑุฆูุณู** (`buildAdvancedPrompt`) - โ
2. **ุงููุณุงุฑ ุงูุฃุณุงุณู** (`buildPrompt`) - โ
3. **ูุณุงุฑ Retry** (`buildAdvancedPrompt` ูู retry) - โ (ุชู ุฅุตูุงุญู)

### ๐ ุงููุชูุฌุฉ:

**โ ูุนูุ ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ ุจุตูุฉ ุนุงูุฉ ุชุฏุฎู ูู ุจูุงุก ุงูุฑุฏ**

- ุฌููุน ุงููุณุงุฑุงุช ุงูุฑุฆูุณูุฉ ุชุณุชุฎุฏู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ
- ุญุชู ูู ุญุงูุฉ retryุ ูุชู ุงุณุชุฎุฏุงู `buildAdvancedPrompt` ุงูุฐู ูุญุชูู ุนูู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ
- ุฅุฐุง ูู ุชูู ุงูููุงุนุฏ ููุฌูุฏุฉุ ูุชู ุงุณุชุฎุฏุงู ุงูููุงุนุฏ ุงูุงูุชุฑุงุถูุฉ

---

## ๐ ุงูุชุญูู

### ุงูุฎุทูุงุช ููุชุญูู:

1. ุงูุชุญ Console logs ุนูุฏ ุฅุฑุณุงู ุฑุณุงูุฉ
2. ุงุจุญุซ ุนู:
   - `โ [RESPONSE-RULES] Using custom response rules`
   - `โ [RESPONSE-RULES] Response rules added to prompt`
   - `โ [RETRY] Using buildAdvancedPrompt with response rules` (ูู ุญุงูุฉ retry)

### ุงูู Logs ุงููุชููุนุฉ:

```
๐ [RESPONSE-RULES] Checking for response rules...
โ [RESPONSE-RULES] Using custom response rules: {
  responseLength: 'short',
  speakingStyle: 'friendly',
  dialect: 'egyptian',
  rulesCount: 10
}
โ [RESPONSE-RULES] Response rules added to prompt, length: 450
```

---

## ๐ ููุงุญุธุงุช

- **ุงูููุงุนุฏ ุงูุงูุชุฑุงุถูุฉ:** ุฅุฐุง ูู ุชูู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ ููุฌูุฏุฉุ ูุชู ุงุณุชุฎุฏุงู ุงูููุงุนุฏ ุงูุงูุชุฑุงุถูุฉ (`DEFAULT_RESPONSE_RULES`)
- **Retry Logic:** ุชู ุฅุตูุงุญ retry logic ูุงุณุชุฎุฏุงู `buildAdvancedPrompt` ุจุฏูุงู ูู prompt ุจุณูุท
- **Fallback:** ูู ุญุงูุฉ ูุดู `buildAdvancedPrompt` ูู retryุ ูุชู ุงุณุชุฎุฏุงู prompt ุจุณูุท ูู fallback

---

**ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุฑูุฑ ุจูุงุณุทุฉ:** AI Assistant  
**ุงูุชุงุฑูุฎ:** 2025-11-28

