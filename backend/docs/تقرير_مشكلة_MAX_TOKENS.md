# ๐ ุชูุฑูุฑ ููุตู - ูุดููุฉ MAX_TOKENS ูู ูุธุงู ุงูุฐูุงุก ุงูุตูุงุนู

**ุชุงุฑูุฎ ุงููุญุต:** $(date)  
**ุงููููุงุช ุงูููุญูุตุฉ:**
- `backend/services/aiAgent/responseGenerator.js`
- `backend/services/responseGenerator.js`
- `backend/aiAgentService.js`

---

## ๐ ููุฎุต ุงููุดููุฉ

### ุงููุดููุฉ ุงูุฑุฆูุณูุฉ:
ููุงู **ุชูุงูุถ ูุงุถุญ** ูู ูุนุงูุฌุฉ `MAX_TOKENS` ูู ุงูููุฏ:
- **ุงูุณุทุฑ 1406**: ูุณุชุฎุฏู `maxTokens: 8192` ูู retry
- **ุงูุณุทุฑ 1435**: ููุชุจ ูู ุงูุณุฌู `retriedWithMaxTokens: 32768` (ูููุฉ ุฎุงุทุฆุฉ!)
- **ุงูุณุทุฑ 30**: ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ `4096` tokens (ูู `responseGenerator.js`)
- **ุงูุณุทุฑ 313**: ุงููููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุงูุชุฑุงุถูุฉ `1024` tokens
- **ุงููุงุฌูุฉ**: ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ `1024` tokens (ูู `AIManagement.tsx` ุงูุณุทุฑ 363)
- **โ๏ธ ูุดููุฉ ุญุฑุฌุฉ**: ุงูุณุทุฑ 30 ูุณุชุฎุฏู `||` ุจุฏูุงู ูู `??` - ูุฏ ูุชุฌุงูู ุงููููุฉ ูู ุงููุงุฌูุฉ!

### ุงููุดุงูู ุงูููุชุดูุฉ:

#### 1. โ **ุชูุงูุถ ูู ุงูููู (Critical)**
```javascript
// ุงูุณุทุฑ 1406 - ุงููููุฉ ุงููุนููุฉ ุงููุณุชุฎุฏูุฉ
maxTokens: 8192, // โ ุชุญุณูู: ุชูููู ูู 32768 ุฅูู 8192
A
// ุงูุณุทุฑ 1435 - ุงููููุฉ ุงูููุชูุจุฉ ูู ุงูุณุฌู (ุฎุงุทุฆุฉ!)
retriedWithMaxTokens: 32768 // โ ุชูุงูุถ - ููุชุจ 32768 ููู ูุณุชุฎุฏู 8192
```

**ุงูุชุฃุซูุฑ:**
- ุตุนูุจุฉ ุชุชุจุน ุงููุดููุฉ ูู ุงูุณุฌูุงุช
- ูุนูููุงุช ูุถููุฉ ุนูุฏ ุชุญููู ุงูุฃุฎุทุงุก
- ุตุนูุจุฉ ูู debugging

---

#### 2. โ **ุนุฏู ุชูุญูุฏ ุงูููู ุงูุงูุชุฑุงุถูุฉ (High Priority)**

**ุงูููู ุงููุฎุชููุฉ ุงูููุฌูุฏุฉ:**
- `backend/services/aiAgent/responseGenerator.js` ุงูุณุทุฑ 30: `4096` (ุงูุงูุชุฑุงุถู) โ๏ธ
- `backend/services/responseGenerator.js` ุงูุณุทุฑ 30: `8192` (ุงูุงูุชุฑุงุถู)
- `backend/aiAgentService.js` ุงูุณุทุฑ 2100: `8192` (ุงูุงูุชุฑุงุถู)
- `backend/prisma/schema.prisma` ุงูุณุทุฑ 519: `1024` (ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช)
- `backend/services/aiAgent/settingsManager.js` ุงูุณุทุฑ 313: `1024` (ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช)
- `frontend/src/pages/ai/AIManagement.tsx` ุงูุณุทุฑ 363: `1024` (ูู ุงููุงุฌูุฉ)

**โ๏ธ ูุดููุฉ ุญุฑุฌุฉ ูู ุงูุณุทุฑ 30:**
```javascript
// ุงูุณุทุฑ 30 ูู responseGenerator.js
maxOutputTokens: settings.aiMaxTokens || 4096, // โ ุฎุทุฃ!

// ุงููุดููุฉ: ุฅุฐุง ูุงูุช settings.aiMaxTokens = 0 (ูููุฉ ุตุงูุญุฉ)ุ ุณูุณุชุฎุฏู 4096 ุจุฏูุงู ูููุง!
// ุงูุญู: ูุฌุจ ุงุณุชุฎุฏุงู ?? ุจุฏูุงู ูู ||
maxOutputTokens: settings.aiMaxTokens ?? 4096, // โ ุตุญูุญ
```

**ุงูุชุฃุซูุฑ:**
- **ุฅุฐุง ุถุจุท ุงููุณุชุฎุฏู 2048 ูู ุงููุงุฌูุฉ**: ุณูุชู ุงุณุชุฎุฏุงููุง ุจุดูู ุตุญูุญ โ
- **ุฅุฐุง ุถุจุท ุงููุณุชุฎุฏู 0 ูู ุงููุงุฌูุฉ**: ุณูุชู ุชุฌุงูููุง ูุงุณุชุฎุฏุงู 4096 โ
- **ุฅุฐุง ูุงูุช ุงููููุฉ null/undefined**: ุณูุชู ุงุณุชุฎุฏุงู 4096 โ
- **ุณููู ุบูุฑ ูุชููุน ุญุณุจ ุงูููู ุงููุณุชุฎุฏู**
- **ุตุนูุจุฉ ูู ุงูุชูุจุค ุจุณููู ุงููุธุงู**
- **ูุดุงูู ูู ุงูุงุฎุชุจุงุฑ**

---

#### 3. โ **Retry Logic ุบูุฑ ูุนุงู (High Priority)**

**ุงููุดุงูู:**
1. **ุงูุณุทุฑ 1406**: retry ุจู `8192` tokens ูุฏ ูููู ูููู ููููุงุฐุฌ ุงููุจูุฑุฉ
2. **ุงูุณุทุฑ 1412**: retry ูุณุชุฏุนู `generateAIResponse` ุจุดูู recursive - ูุฏ ูุคุฏู ุฅูู stack overflow
3. **ุงูุณุทุฑ 1400**: retry ูุฑุฉ ูุงุญุฏุฉ ููุท - ูุฏ ูุง ูููู ูุงููุงู
4. **ุงูุณุทุฑ 1413**: ุนูุฏ retryุ ูุณุชุฎุฏู ููุณ ุงูู prompt ุงููุงูู ุงูุฐู ูุฏ ูููู ุทูููุงู ุฌุฏุงู

**ุงูููุฏ ุงูุญุงูู:**
```javascript
// ุงูุณุทุฑ 1395-1420
if (!aiContent || aiContent.trim().length === 0) {
  if (!messageContext?._retried_max_tokens) {
    const retryContext = {
      ...messageContext,
      maxTokens: 8192, // โ ูุฏ ูููู ูููู
      temperature: 0.3,
      _retried_max_tokens: true
    };
    
    // โ Recursive call - ูุฏ ูุคุฏู ุฅูู stack overflow
    return await this.generateAIResponse(
      prompt, // โ ููุณ ุงูู prompt ุงููุงูู - ูุฏ ูููู ุทูููุงู ุฌุฏุงู
      conversationMemory,
      useRAG,
      providedGeminiConfig,
      companyId,
      conversationId,
      retryContext
    );
  }
}
```

**ุงูุชุฃุซูุฑ:**
- ูุฏ ููุดู retry ุฅุฐุง ูุงู ุงูู prompt ุทูููุงู ุฌุฏุงู
- ููุฏุงู ุฑุฏูุฏ ุตุญูุญุฉ ุจุณุจุจ truncation
- ุฎุทุฑ stack overflow ูู ุงููุญุงุฏุซุงุช ุงูุทูููุฉ

---

#### 4. โ **ุนุฏู ุชูููู ุทูู ุงูู Prompt ูู Retry (Medium Priority)**

**ุงููุดููุฉ:**
- ุนูุฏ retryุ ูุณุชุฎุฏู ููุณ ุงูู prompt ุงููุงูู
- ุฅุฐุง ูุงู ุงูู prompt ุทูููุงู ุฌุฏุงู (ูุซูุงู 8000 tokens)ุ ุญุชู ูุน `maxOutputTokens: 8192` ูุฏ ููุดู

**ุงูุชุฃุซูุฑ:**
- retry ูุฏ ููุดู ูููุณ ุงูุณุจุจ
- ุงุณุชููุงู tokens ุบูุฑ ุถุฑูุฑู

---

#### 5. โ **ุนุฏู ูุนุงูุฌุฉ Partial Content ุจุดูู ุตุญูุญ (Medium Priority)**

**ุงููุดููุฉ:**
- ุงูุณุทุฑ 1379-1383: ูุญุงูู ุงุณุชุฎุฑุงุฌ partial content
- ููู ุฅุฐุง ูุงู partial content ุบูุฑ ูููุฏ (ูุซู: ุฌููุฉ ุบูุฑ ููุชููุฉ)ุ ูุชู ุชุฌุงููู

**ุงูููุฏ ุงูุญุงูู:**
```javascript
// ุงูุณุทุฑ 1379-1383
if (candidate.content?.parts && candidate.content.parts.length > 0) {
  aiContent = candidate.content.parts.map(part => part.text || '').join('');
  if (aiContent && aiContent.trim().length > 0) {
    console.log(`โ [AI-MAX-TOKENS] Extracted partial content`);
  }
}
// โ ูุง ูุชุญูู ูู ุฌูุฏุฉ partial content
```

**ุงูุชุฃุซูุฑ:**
- ูุฏ ูููุฏ ุฑุฏูุฏ ูููุฏุฉ ุฌุฒุฆูุงู
- ูุฏ ููุจู ุฑุฏูุฏ ุบูุฑ ููุชููุฉ

---

## ๐จ ุงููุดุงูู ุงูุชู ุณุชุณุจุจูุง

### 1. **ุงุณุชุฌุงุจุงุช ุบูุฑ ููุชููุฉ**
- **ุงูุณุจุจ**: `maxOutputTokens` ููุฎูุถ ุฌุฏุงู ุฃู prompt ุทููู ุฌุฏุงู
- **ุงููุชูุฌุฉ**: ุงูุนููู ูุญุตู ุนูู ุฑุฏ ููุทูุน
- **ุงูุชุฃุซูุฑ**: ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุณูุฆุฉ

### 2. **ูุดู Retry**
- **ุงูุณุจุจ**: retry ูุณุชุฎุฏู ููุณ ุงูู prompt ุงูุทููู
- **ุงููุชูุฌุฉ**: retry ููุดู ูููุณ ุงูุณุจุจ
- **ุงูุชุฃุซูุฑ**: ููุฏุงู ูุฑุตุฉ ุชูููุฏ ุฑุฏ ุจุฏูู

### 3. **ุงุณุชููุงู Tokens ุบูุฑ ูุญุณูุจ**
- **ุงูุณุจุจ**: ููู ูุฎุชููุฉ ูู ุฃูุงูู ูุฎุชููุฉ
- **ุงููุชูุฌุฉ**: ุงุณุชููุงู tokens ุบูุฑ ูุชููุน
- **ุงูุชุฃุซูุฑ**: ุชูุงููู ุฃุนูู

### 4. **ุตุนูุจุฉ ูู Debugging**
- **ุงูุณุจุจ**: ุชูุงูุถ ูู ุงูููู ุงูููุชูุจุฉ ูู ุงูุณุฌูุงุช
- **ุงููุชูุฌุฉ**: ุตุนูุจุฉ ุชุชุจุน ุงููุดููุฉ
- **ุงูุชุฃุซูุฑ**: ููุช ุฃุทูู ูู ุฅุตูุงุญ ุงููุดุงูู

### 5. **Stack Overflow (ุฎุทุฑ ูุญุชูู)**
- **ุงูุณุจุจ**: retry recursive ุจุฏูู ุญุฏ ุฃูุตู ูุงุถุญ
- **ุงููุชูุฌุฉ**: crash ูู ุงููุญุงุฏุซุงุช ุงูุทูููุฉ
- **ุงูุชุฃุซูุฑ**: ุชููู ุงููุธุงู

---

## ๐ ููุงุฑูุฉ ูุน ุงููุดุงุฑูุน ุงููุดุงุจูุฉ

### ุฃูุถู ุงูููุงุฑุณุงุช ูู ุงูุจุญุซ:

#### 1. **ุชุญุฏูุฏ ูููุฉ ููุงุณุจุฉ ูู max_tokens**
- ูุฌุจ ุฃู ุชุชูุงุณุจ ูุน ุทูู ุงูุงุณุชุฌุงุจุงุช ุงููุชููุนุฉ
- ูุง ุชููู ููุฎูุถุฉ ุฌุฏุงู (ุงุณุชุฌุงุจุงุช ุบูุฑ ููุชููุฉ)
- ูุง ุชููู ุนุงููุฉ ุฌุฏุงู (ุงุณุชููุงู ุบูุฑ ุถุฑูุฑู)

#### 2. **ุงุณุชุฎุฏุงู Retry Logic ูุน ุชุนุฏูู ุงููุนููุงุช**
- ูู ุญุงูุฉ `MAX_TOKENS`ุ ูุฌุจ:
  - ุฒูุงุฏุฉ `maxOutputTokens` ุชุฏุฑูุฌูุงู
  - ุชูููู ุทูู ุงูู prompt ุฅุฐุง ูุงู ุทูููุงู
  - ุงุณุชุฎุฏุงู iterative retry ุจุฏูุงู ูู recursive

#### 3. **ูุฑุงูุจุฉ ุงูุฃุฏุงุก ูุชุนุฏูู ุงููุนููุงุช**
- ุชุชุจุน ูุนุฏู `MAX_TOKENS` errors
- ุชุนุฏูู `maxOutputTokens` ุจูุงุกู ุนูู ุงูุจูุงูุงุช
- ุงุณุชุฎุฏุงู ููู ูุฎุชููุฉ ุญุณุจ ููุน ุงูุฑุณุงูุฉ

---

## ๐ง ุงูุญููู ุงูููุชุฑุญุฉ

### 1. โ **ุฅุตูุงุญ ุงุณุชุฎุฏุงู || ุจุฏูุงู ูู ?? (Critical)**
```javascript
// โ ุงูููุฏ ุงูุญุงูู (ุฎุทุฃ)
maxOutputTokens: settings.aiMaxTokens || 4096

// โ ุงูููุฏ ุงูุตุญูุญ
maxOutputTokens: settings.aiMaxTokens ?? 4096

// ุงูุณุจุจ: || ูุชุนุงูู ูุน 0 ููููุฉ falsyุ ุจูููุง ?? ูุชุนุงูู ูุน null/undefined ููุท
```

### 2. โ **ุชูุญูุฏ ุงูููู ุงูุงูุชุฑุงุถูุฉ**
```javascript
// ูู ุฌููุน ุงููููุงุชุ ุงุณุชุฎุฏุงู ููุณ ุงููููุฉ
const DEFAULT_MAX_OUTPUT_TOKENS = 2048; // โ ุชูุญูุฏ ูุน ุงููุงุฌูุฉ ููุงุนุฏุฉ ุงูุจูุงูุงุช

// ูู buildGenerationConfig
maxOutputTokens: settings.aiMaxTokens ?? DEFAULT_MAX_OUTPUT_TOKENS

// ูู ุฌููุน ุงููููุงุช ุงูุฃุฎุฑู:
// - responseGenerator.js: 2048
// - aiAgentService.js: 2048
// - settingsManager.js: 2048 (ููุฌูุฏ ุจุงููุนู)
// - schema.prisma: 1024 โ ูุฌุจ ุชุญุฏูุซู ุฅูู 2048
```

### 2. โ **ุฅุตูุงุญ ุงูุชูุงูุถ ูู ุงูุณุฌูุงุช**
```javascript
// ุงูุณุทุฑ 1435 - ุฅุตูุงุญ
retriedWithMaxTokens: retryContext.maxTokens || 8192 // โ ุงุณุชุฎุฏุงู ุงููููุฉ ุงููุนููุฉ
```

### 3. โ **ุชุญุณูู Retry Logic**
```javascript
// ุงุณุชุฎุฏุงู iterative retry ุจุฏูุงู ูู recursive
// ุฒูุงุฏุฉ maxOutputTokens ุชุฏุฑูุฌูุงู: 4096 -> 8192 -> 16384
// ุชูููู ุทูู ุงูู prompt ูู retry
```

### 4. โ **ุฅุถุงูุฉ Prompt Truncation ูู Retry**
```javascript
// ุฅุฐุง ูุงู prompt ุทูููุงู ุฌุฏุงูุ ุชููููู ูู retry
if (prompt.length > MAX_PROMPT_LENGTH) {
  // ุชูููู conversationMemory
  // ุชูููู ragData
  // ุงูุญูุงุธ ุนูู ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ ููุท
}
```

### 5. โ **ุชุญุณูู ูุนุงูุฌุฉ Partial Content**
```javascript
// ุงูุชุญูู ูู ุฌูุฏุฉ partial content
// ูุจูู partial content ุฅุฐุง ูุงู ูููุฏุงู
// ุฑูุถ partial content ุฅุฐุง ูุงู ุบูุฑ ููุชูู
```

### 6. โ **ุฅุถุงูุฉ ุญุฏ ุฃูุตู ูุนุฏุฏ Retries**
```javascript
// ููุน recursive calls ุงููุงููุงุฆูุฉ
const MAX_RETRIES = 2;
if (retryCount >= MAX_RETRIES) {
  // ุฅุฑุฌุงุน error ุจุฏูุงู ูู retry
}
```

---

## ๐ ุงูููู ุงูููุชุฑุญุฉ

### ุญุณุจ ููุน ุงูุฑุณุงูุฉ:
- **greeting/casual_chat**: `2048` tokens (ุฑุฏูุฏ ูุตูุฑุฉ)
- **product_inquiry**: `4096` tokens (ุฑุฏูุฏ ูุชูุณุทุฉ)
- **order_confirmation**: `8192` tokens (ุฑุฏูุฏ ุทูููุฉ ูุน ุชูุงุตูู)
- **complaint/problem**: `6144` tokens (ุฑุฏูุฏ ูุชูุณุทุฉ-ุทูููุฉ)

### ูู Retry:
- **ุงููุญุงููุฉ ุงูุฃููู**: ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ
- **ุงููุญุงููุฉ ุงูุซุงููุฉ**: `maxOutputTokens * 2`
- **ุงููุญุงููุฉ ุงูุซุงูุซุฉ**: `maxOutputTokens * 4` (ุญุฏ ุฃูุตู)

---

## ๐ฏ ุงูุฃููููุงุช

### ุฃููููุฉ ุนุงููุฉ (ูุฌุจ ุฅุตูุงุญูุง ููุฑุงู):
1. โ **ุฅุตูุงุญ ุงุณุชุฎุฏุงู || ุจุฏูุงู ูู ?? ูู ุงูุณุทุฑ 30** (Critical - ูุฏ ูุชุฌุงูู ุฅุนุฏุงุฏุงุช ุงููุณุชุฎุฏู!)
2. โ ุฅุตูุงุญ ุงูุชูุงูุถ ูู ุงูุณุทุฑ 1435
3. โ ุชูุญูุฏ ุงูููู ุงูุงูุชุฑุงุถูุฉ (2048 ูู ุฌููุน ุงูุฃูุงูู)
4. โ ุฅุถุงูุฉ ุญุฏ ุฃูุตู ูุนุฏุฏ Retries

### ุฃููููุฉ ูุชูุณุทุฉ (ูุฌุจ ุฅุตูุงุญูุง ูุฑูุจุงู):
4. โ ุชุญุณูู Retry Logic (iterative ุจุฏูุงู ูู recursive)
5. โ ุฅุถุงูุฉ Prompt Truncation ูู Retry
6. โ ุชุญุณูู ูุนุงูุฌุฉ Partial Content

### ุฃููููุฉ ููุฎูุถุฉ (ูููู ุชุฃุฌูููุง):
7. โ ุฅุถุงูุฉ ูุฑุงูุจุฉ ููุฃุฏุงุก
8. โ ุชุญุณูู ุงูููู ุญุณุจ ููุน ุงูุฑุณุงูุฉ

---

## ๐ ููุงุญุธุงุช ุฅุถุงููุฉ

1. **ุงูุฃุฏุงุก**: ุงููุธุงู ูุญุชุงุฌ ุฅูู ุชุญุณููุงุช ูู ูุนุงูุฌุฉ `MAX_TOKENS` ูุชูููู ูุดู ุงูุฑุฏูุฏ
2. **ุงูุชูููุฉ**: ุงุณุชุฎุฏุงู ููู ููุงุณุจุฉ ูู `maxOutputTokens` ูุชูููู ุงุณุชููุงู tokens
3. **ุงูุชุฌุฑุจุฉ**: ุชุญุณูู ูุนุงูุฌุฉ `MAX_TOKENS` ูุถูุงู ุญุตูู ุงูุนููู ุนูู ุฑุฏูุฏ ูุงููุฉ

---

**ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุฑูุฑ ุจูุงุณุทุฉ:** AI Assistant  
**ุงูุชุงุฑูุฎ:** $(date)

