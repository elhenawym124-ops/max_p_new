# ๐ ุชุญููู ุดุงูู - ูุดุงูู ูุธุงู ุงูุชุจุฏูู ุจูู ุงูููุงุชูุญ ูุฅุฏุงุฑุฉ ุงูููุชุฉ ูุงูุญููู

**ุชุงุฑูุฎ ุงูุชุญููู:** $(date)  
**ุงููููุงุช ุงูููุญูุตุฉ:**
- `backend/services/aiAgent/modelManager.js`
- `backend/services/aiAgent/responseGenerator.js`
- `backend/services/aiAgent/aiConstants.js`
- `backend/aiAgentService.js`

---

## ๐ ููุฎุต ุงููุดุงูู

ุชู ุงูุชุดุงู **9 ูุดุงูู ุญุฑุฌุฉ** ูู ูุธุงู ุงูุชุจุฏูู ุจูู ุงูููุงุชูุญ ูุฅุฏุงุฑุฉ ุงูููุชุฉ:

1. โ **ุนุฏู ูุดุงุฑูุฉ triedModels ุจูู ุงูุฏูุงู** (Critical)
2. โ **findNextAvailableModel ูุง ูุณุชุซูู ุงูููุงุฐุฌ ุงููุฌุฑุจุฉ** (Critical)
3. โ **Race condition ูู markModelAsExhaustedFrom429** (Critical)
4. โ **exhaustedModelsCache ูุง ูููุญุต ูู findBestModelByPriorityWithQuota** (High Priority)
5. โ **ุนุฏู ุชุฒุงูู ุจูู exhaustedModelsCache ู excludedModels** (High Priority)
6. โ **Cache TTL ูุตูุฑ ุฌุฏุงู (10 ุซูุงูู)** (Medium Priority)
7. โ **ุนุฏู ูุฌูุฏ ุญุฏ ุฃูุตู ูููุญุงููุงุช** (High Priority)
8. โ **selectBestModelByPriority ุฏุงุฆูุงู ูุฎุชุงุฑ ุงูุฃูู** (Critical)

---

## ๐ ุชูุงุตูู ุงููุดุงูู ูุงูุญููู

### ุงููุดููุฉ 1: ุนุฏู ูุดุงุฑูุฉ triedModels ุจูู ุงูุฏูุงู โ (Critical)

#### ุงููุตู:
- `triedModels` ูุชู ุชุนุฑููู ูุญููุงู ูู `responseGenerator.js` ุฏุงุฎู catch block
- ูุง ูุชู ุชูุฑูุฑู ุฅูู `findNextAvailableModel`
- ุงููุชูุฌุฉ: ุงููุธุงู ูุฏ ูุฌุฑุจ ููุณ ุงููููุฐุฌ ูู ููุงุชูุญ ูุฎุชููุฉ

#### ุงูููุฏ ุงูุญุงูู:
```javascript
// backend/services/aiAgent/responseGenerator.js - ุงูุณุทุฑ 1735-1870
} catch (error) {
  const triedModels = new Set(); // โ ูุญูู ููุท
  if (geminiConfig?.model) {
    triedModels.add(geminiConfig.model);
  }
  
  // ...
  
  const backupModel = await this.aiAgentService.findNextAvailableModel(companyId);
  // โ ูุง ูุชู ุชูุฑูุฑ triedModels!
  
  triedModels.add(backupModel.model);
  
  const secondBackupModel = await this.aiAgentService.findNextAvailableModel(companyId);
  // โ ูุง ูุชู ุชูุฑูุฑ triedModels ูุฑุฉ ุฃุฎุฑู!
}
```

#### ุงููุดููุฉ:
- `triedModels` ูุญูู ููุง ูุชู ูุดุงุฑูุชู ูุน `findNextAvailableModel`
- ูุฏ ูุชู ุชุฌุฑุจุฉ ููุณ ุงููููุฐุฌ ูู ููุงุชูุญ ูุฎุชููุฉ
- ููุฏุงู ุงูููุช ูู ูุญุงููุงุช ุบูุฑ ูุฌุฏูุฉ

#### ุงูุญู ุงูููุชุฑุญ:
```javascript
// 1. ุชุนุฏูู findNextAvailableModel ููุจูู excludeModels
async findNextAvailableModel(companyId, options = {}) {
  const { excludeModels = [] } = options;
  
  // ุงุณุชุฎุฏุงู ุงููุธุงู ุงูุฌุฏูุฏ ูุน ุงุณุชุซูุงุก ุงูููุงุฐุฌ ุงููุฌุฑุจุฉ
  const newSystemResult = await this.findBestModelByPriorityWithQuota(
    targetCompanyId, 
    { excludeModels } // โ ุชูุฑูุฑ ุงูููุงุฐุฌ ุงููุณุชุซูุงุฉ
  );
  
  // ...
}

// 2. ุชุนุฏูู responseGenerator.js ูุชูุฑูุฑ triedModels
const backupModel = await this.aiAgentService.findNextAvailableModel(companyId, {
  excludeModels: Array.from(triedModels) // โ ุชูุฑูุฑ ุงูููุงุฐุฌ ุงููุฌุฑุจุฉ
});
```

#### ุงูุชุฃุซูุฑ ุงููุชููุน:
- โ **ููุน ุชุฌุฑุจุฉ ููุณ ุงููููุฐุฌ**: ูู ูุชู ุชุฌุฑุจุฉ ููุณ ุงููููุฐุฌ ูู ููุงุชูุญ ูุฎุชููุฉ
- โ **ุชูููุฑ ุงูููุช**: ุชูููู ุงููุญุงููุงุช ุบูุฑ ุงููุฌุฏูุฉ
- โ **ุชุญุณูู ุงูุฃุฏุงุก**: ุงูุจุญุซ ุนู ููุงุฐุฌ ุฌุฏูุฏุฉ ูุจุงุดุฑุฉ
- โ **ุฏูุฉ ุฃุนูู**: ุงููุธุงู ุณูุฌุฑุจ ููุงุฐุฌ ูุฎุชููุฉ ูุนููุงู

---

### ุงููุดููุฉ 2: findNextAvailableModel ูุง ูุณุชุซูู ุงูููุงุฐุฌ ุงููุฌุฑุจุฉ โ (Critical)

#### ุงููุตู:
- `findNextAvailableModel` ูุง ููุจู ูุงุฆูุฉ ุจุงูููุงุฐุฌ ุงููุณุชุซูุงุฉ
- ูุง ูููู ุงุณุชุซูุงุก ุงูููุงุฐุฌ ุงูุชู ุชู ุชุฌุฑุจุชูุง ุจุงููุนู
- ุงููุชูุฌุฉ: ูุฏ ูุชู ุงุฎุชูุงุฑ ููุณ ุงููููุฐุฌ ูุฑุฉ ุฃุฎุฑู

#### ุงูููุฏ ุงูุญุงูู:
```javascript
// backend/services/aiAgent/modelManager.js - ุงูุณุทุฑ 863-940
async findNextAvailableModel(companyId) {
  // โ ูุง ููุจู excludeModels parameter
  // โ ูุง ูุณุชุซูู ุงูููุงุฐุฌ ุงููุฌุฑุจุฉ
  
  const newSystemResult = await this.findBestModelByPriorityWithQuota(targetCompanyId);
  // โ ูุง ูุชู ุชูุฑูุฑ ุงูููุงุฐุฌ ุงููุณุชุซูุงุฉ
}
```

#### ุงููุดููุฉ:
- ูุง ูููู ุงุณุชุซูุงุก ุงูููุงุฐุฌ ุงููุฌุฑุจุฉ
- ูุฏ ูุชู ุงุฎุชูุงุฑ ููุณ ุงููููุฐุฌ ุงููุณุชููุฏ
- ููุฏุงู ุงูููุช ูู ูุญุงููุงุช ููุฑุฑุฉ

#### ุงูุญู ุงูููุชุฑุญ:
```javascript
// 1. ุชุนุฏูู findNextAvailableModel
async findNextAvailableModel(companyId, options = {}) {
  const { excludeModels = [], excludeModelKeys = [] } = options;
  
  // ุงุณุชุฎุฏุงู ุงููุธุงู ุงูุฌุฏูุฏ ูุน ุงุณุชุซูุงุก ุงูููุงุฐุฌ ุงููุฌุฑุจุฉ
  const newSystemResult = await this.findBestModelByPriorityWithQuota(
    targetCompanyId,
    { excludeModels, excludeModelKeys }
  );
  
  // ...
}

// 2. ุชุนุฏูู findBestModelByPriorityWithQuota
async findBestModelByPriorityWithQuota(companyId, options = {}) {
  const { excludeModels = [], excludeModelKeys = [] } = options;
  
  // ...
  
  // 6. ูุญุต ุงูุงุณุชุซูุงุกุงุช (ุชุฎุทู ุงูููุงุฐุฌ ุงููุณุชุซูุงุฉ)
  const availableModelsAfterExclusion = [];
  for (const modelRecord of quota.availableModels) {
    // โ ุงุณุชุซูุงุก ุงูููุงุฐุฌ ุงููุฌุฑุจุฉ
    if (excludeModels.includes(modelRecord.model)) {
      continue;
    }
    
    // โ ุงุณุชุซูุงุก ุงูููุงุฐุฌ ูู ููุงุชูุญ ูุญุฏุฏุฉ
    if (excludeModelKeys.includes(modelRecord.keyId)) {
      continue;
    }
    
    const isExcluded = await this.isModelExcluded(modelRecord.model, modelRecord.keyId, companyId);
    if (!isExcluded) {
      availableModelsAfterExclusion.push(modelRecord);
    }
  }
  
  // ...
}
```

#### ุงูุชุฃุซูุฑ ุงููุชููุน:
- โ **ุฏูุฉ ุฃุนูู**: ูู ูุชู ุงุฎุชูุงุฑ ุงูููุงุฐุฌ ุงููุฌุฑุจุฉ
- โ **ุชูููุฑ ุงูููุช**: ุชูููู ุงููุญุงููุงุช ุงูููุฑุฑุฉ
- โ **ุชุญุณูู ุงูุฃุฏุงุก**: ุงูุจุญุซ ุนู ููุงุฐุฌ ุฌุฏูุฏุฉ ูุจุงุดุฑุฉ
- โ **ูุฑููุฉ ุฃูุจุฑ**: ูููู ุงุณุชุซูุงุก ููุงุฐุฌ ุฃู ููุงุชูุญ ูุญุฏุฏุฉ

---

### ุงููุดููุฉ 3: Race condition ูู markModelAsExhaustedFrom429 โ (Critical)

#### ุงููุตู:
- `markModelAsExhaustedFrom429` ูุชู ุงุณุชุฏุนุงุคู ุจุนุฏ ูุดู ุงููููุฐุฌ
- ุฅุฐุง ุญุฏุซ ุทูุจุงู ูุชุฒุงููุงูุ ูุฏ ูุชู ุงุฎุชูุงุฑ ููุณ ุงููููุฐุฌ ูุจู ุชุญุฏูุซู
- ุงููุชูุฌุฉ: ูุฏ ูุชู ุงุฎุชูุงุฑ ูููุฐุฌ ูุณุชููุฏ

#### ุงูููุฏ ุงูุญุงูู:
```javascript
// backend/services/aiAgent/responseGenerator.js - ุงูุณุทุฑ 1859
if (modelName) {
  await this.aiAgentService.markModelAsExhaustedFrom429(modelName, quotaValue, companyId);
  // โ๏ธ ุชุญุฏูุซ ุบูุฑ ูุชุฒุงูู - ูุฏ ูุชู ุงุฎุชูุงุฑ ููุณ ุงููููุฐุฌ ูุจู ุงูุชุญุฏูุซ
}

const secondBackupModel = await this.aiAgentService.findNextAvailableModel(companyId);
// โ๏ธ ูุฏ ูุชู ุงุฎุชูุงุฑ ููุณ ุงููููุฐุฌ ูุจู ุฃู ูุชู ุชุญุฏูุซู ูู markModelAsExhaustedFrom429
```

#### ุงููุดููุฉ:
- ุชุญุฏูุซ ุบูุฑ ูุชุฒุงูู
- Race condition: ุทูุจุงู ูุชุฒุงููุงู ูุฏ ูุฎุชุงุฑุงู ููุณ ุงููููุฐุฌ
- ูุฏ ูุชู ุงุฎุชูุงุฑ ูููุฐุฌ ูุณุชููุฏ

#### ุงูุญู ุงูููุชุฑุญ:
```javascript
// 1. ุชุญุฏูุซ ููุฑู ูู cache ูุจู ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช
async markModelAsExhaustedFrom429(modelName, quotaValue, companyId = null) {
  // โ ุชุญุฏูุซ ููุฑู ูู cache ุฃููุงู
  if (!this.exhaustedModelsCache) {
    this.exhaustedModelsCache = new Set();
  }
  this.exhaustedModelsCache.add(modelName); // โ ุชุญุฏูุซ ููุฑู
  
  // โ Invalidate quota cache
  const cacheKey = `${modelName}_${companyId || 'null'}`;
  this.quotaCache.delete(cacheKey);
  
  // โ ุซู ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช (async)
  try {
    const whereClause = companyId 
      ? { model: modelName, key: { companyId: companyId } }
      : { model: modelName };

    const modelRecords = await this.prisma.geminiKeyModel.findMany({
      where: whereClause,
      include: { key: true }
    });

    // ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช...
  } catch (error) {
    console.error('โ ุฎุทุฃ ูู ุชุญุฏูุฏ ุงููููุฐุฌ ููุณุชููุฏ:', error);
  }
}

// 2. ุงุณุชุฎุฏุงู Optimistic Locking ูู findBestModelByPriorityWithQuota
async findBestModelByPriorityWithQuota(companyId, options = {}) {
  // ...
  
  // โ ูุญุต exhaustedModelsCache ุฃููุงู (ูุจู ุฃู ุดูุก)
  if (this.exhaustedModelsCache && this.exhaustedModelsCache.has(modelName)) {
    console.log(`โ๏ธ [QUOTA-PRIORITY] ${modelName} ูุณุชููุฏ ูู cache - ุชุฎุทู`);
    continue;
  }
  
  // ...
}
```

#### ุงูุชุฃุซูุฑ ุงููุชููุน:
- โ **ููุน Race Conditions**: ุชุญุฏูุซ ููุฑู ูู cache ูููุน ุงุฎุชูุงุฑ ุงูููุงุฐุฌ ุงููุณุชููุฏุฉ
- โ **ุฏูุฉ ุฃุนูู**: ุงูููุงุฐุฌ ุงููุณุชููุฏุฉ ูู ูุชู ุงุฎุชูุงุฑูุง ุญุชู ูู ุญุฏุซุช ุทูุจุงุช ูุชุฒุงููุฉ
- โ **ุฃุฏุงุก ุฃูุถู**: ูุญุต cache ุฃุณุฑุน ูู ูุญุต ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ **ุชุฒุงูู ุฃูุถู**: Cache invalidation ูุถูู ุงุณุชุฎุฏุงู ุจูุงูุงุช ุญุฏูุซุฉ

---

### ุงููุดููุฉ 4: exhaustedModelsCache ูุง ูููุญุต ูู findBestModelByPriorityWithQuota โ (High Priority)

#### ุงููุตู:
- `findNextModelInKey` ููุญุต `exhaustedModelsCache` (ุงูุณุทุฑ 979)
- ููู `findBestModelByPriorityWithQuota` ูุง ููุญุตู
- ุงููุชูุฌุฉ: ูุฏ ูุชู ุงุฎุชูุงุฑ ูููุฐุฌ ูุณุชููุฏ ูู ุงููุธุงู ุงูุฌุฏูุฏ

#### ุงูููุฏ ุงูุญุงูู:
```javascript
// findNextModelInKey - ุงูุณุทุฑ 979 โ ููุญุตู
if (this.exhaustedModelsCache && this.exhaustedModelsCache.has(modelRecord.model)) {
  console.log(`โ๏ธ [MODEL-MANAGER] ุงููููุฐุฌ ${modelRecord.model} ูู ูุงุฆูุฉ ุงููุณุชููุฏุฉ ุงููุคูุชุฉ`);
  continue;
}

// findBestModelByPriorityWithQuota - ุงูุณุทุฑ 2148 โ ูุง ููุญุตู
async findBestModelByPriorityWithQuota(companyId) {
  // โ ูุง ููุฌุฏ ูุญุต ูู exhaustedModelsCache ููุง!
  for (let i = 0; i < supportedModels.length; i++) {
    const modelName = supportedModels[i];
    // โ ูุง ูุชู ูุญุต exhaustedModelsCache ูุจู ุญุณุงุจ ุงูููุชุฉ
    const quota = await this.calculateTotalQuota(modelName, companyId);
  }
}
```

#### ุงููุดููุฉ:
- ุนุฏู ุงูุงุชุณุงู: ุจุนุถ ุงูุฏูุงู ุชูุญุต cache ูุจุนุถูุง ูุง
- ูุฏ ูุชู ุงุฎุชูุงุฑ ูููุฐุฌ ูุณุชููุฏ ูู ุงููุธุงู ุงูุฌุฏูุฏ
- ููุฏุงู ุงูููุช ูู ุญุณุงุจ ููุชุฉ ููููุฐุฌ ูุณุชููุฏ

#### ุงูุญู ุงูููุชุฑุญ:
```javascript
async findBestModelByPriorityWithQuota(companyId, options = {}) {
  // ...
  
  for (let i = 0; i < supportedModels.length; i++) {
    const modelName = supportedModels[i];
    
    // โ ูุญุต exhaustedModelsCache ุฃููุงู (ูุจู ุฃู ุดูุก)
    if (this.exhaustedModelsCache && this.exhaustedModelsCache.has(modelName)) {
      console.log(`โ๏ธ [QUOTA-PRIORITY] ${modelName} ูุณุชููุฏ ูู cache - ุชุฎุทู`);
      continue; // ุชุฎุทู ุงููููุฐุฌ ุงููุณุชููุฏ
    }
    
    // โ ุซู ุญุณุงุจ ุงูููุชุฉ
    const quota = await this.calculateTotalQuota(modelName, companyId);
    
    // ...
  }
}

// โ ุฃูุถุงู ูู aggregateModelsByPriority
async aggregateModelsByPriority(modelName, companyId) {
  // ...
  
  // โ ูุญุต exhaustedModelsCache ูุจู ุฌูุจ ุงูููุงุฐุฌ
  if (this.exhaustedModelsCache && this.exhaustedModelsCache.has(modelName)) {
    console.log(`โ๏ธ [AGGREGATE] ${modelName} ูุณุชููุฏ ูู cache - ุฅุฑุฌุงุน ูุงุฆูุฉ ูุงุฑุบุฉ`);
    return [];
  }
  
  // ...
}
```

#### ุงูุชุฃุซูุฑ ุงููุชููุน:
- โ **ุงุชุณุงู ูู ุงูุณููู**: ุฌููุน ุงูุฏูุงู ุชูุญุต cache
- โ **ุชูููุฑ ุงูููุช**: ุชุฎุทู ุงูููุงุฐุฌ ุงููุณุชููุฏุฉ ูุจู ุญุณุงุจ ุงูููุชุฉ
- โ **ุฏูุฉ ุฃุนูู**: ูู ูุชู ุงุฎุชูุงุฑ ููุงุฐุฌ ูุณุชููุฏุฉ
- โ **ุฃุฏุงุก ุฃูุถู**: ุชูููุฑ ุงุณุชุนูุงูุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช ุบูุฑ ุถุฑูุฑูุฉ

---

### ุงููุดููุฉ 5: ุนุฏู ุชุฒุงูู ุจูู exhaustedModelsCache ู excludedModels โ (High Priority)

#### ุงููุตู:
- `exhaustedModelsCache` ูู `Set` (ุงูุณุทุฑ 18)
- `excludedModels` ูู `Map` (ุงูุณุทุฑ 22)
- ูุง ููุฌุฏ ุชุฒุงูู ุจููููุง
- `markModelAsExhaustedFrom429` ูุถูู ูู `exhaustedModelsCache` ููุท
- `excludeModel` ูุถูู ูู `excludedModels` ููุท

#### ุงูููุฏ ุงูุญุงูู:
```javascript
// ุงูุณุทุฑ 18-22
this.exhaustedModelsCache = new Set(); // โ ููููุงุฐุฌ ุงููุณุชููุฏุฉ (429)
this.excludedModels = new Map(); // โ ููููุงุฐุฌ ุงููุณุชุซูุงุฉ (RPD)

// markModelAsExhaustedFrom429 - ุงูุณุทุฑ 622
this.exhaustedModelsCache.add(modelName); // โ ูุถูู ูู exhaustedModelsCache ููุท

// excludeModel - ุงูุณุทุฑ 1878
this.excludedModels.set(cacheKey, {...}); // โ ูุถูู ูู excludedModels ููุท
```

#### ุงููุดููุฉ:
- ูุธุงูุงู ูููุตูุงู ุจุฏูู ุชุฒุงูู
- ูููุฐุฌ ูุณุชููุฏ ูู `exhaustedModelsCache` ูุฏ ูุง ูููู ูุณุชุซูู ูู `excludedModels`
- ูุฏ ูุคุฏู ุฅูู ุชูุงูุถุงุช ูู ุงุณุชุซูุงุก ุงูููุงุฐุฌ

#### ุงูุญู ุงูููุชุฑุญ:
```javascript
// 1. ุชูุญูุฏ ุงููุธุงู ุฃู ุฅุถุงูุฉ ุชุฒุงูู
async markModelAsExhaustedFrom429(modelName, quotaValue, companyId = null) {
  // โ ุชุญุฏูุซ exhaustedModelsCache
  if (!this.exhaustedModelsCache) {
    this.exhaustedModelsCache = new Set();
  }
  this.exhaustedModelsCache.add(modelName);
  
  // โ ุฃูุถุงู ุฅุถุงูุฉ ูู excludedModels ุฅุฐุง ูุงู RPD ูุณุชููุฏ
  // (ูููู ุฅุถุงูุฉ reason: 'QUOTA_EXHAUSTED_429')
  
  // โ Invalidate quota cache
  const cacheKey = `${modelName}_${companyId || 'null'}`;
  this.quotaCache.delete(cacheKey);
  
  // ...
}

// 2. ุฅุถุงูุฉ ุฏุงูุฉ ููุชุญูู ูู ููุง ุงููุธุงููู
isModelExcludedOrExhausted(modelName, keyId = null, companyId = null) {
  // โ ูุญุต exhaustedModelsCache
  if (this.exhaustedModelsCache && this.exhaustedModelsCache.has(modelName)) {
    return true;
  }
  
  // โ ูุญุต excludedModels
  if (keyId && companyId) {
    const cacheKey = `${modelName}_${keyId}_${companyId}`;
    const excluded = this.excludedModels.get(cacheKey);
    if (excluded && new Date() < new Date(excluded.retryAt)) {
      return true;
    }
  }
  
  return false;
}

// 3. ุงุณุชุฎุฏุงู ุงูุฏุงูุฉ ุงูููุญุฏุฉ ูู ุฌููุน ุงูุฃูุงูู
async findBestModelByPriorityWithQuota(companyId, options = {}) {
  // ...
  
  // โ ุงุณุชุฎุฏุงู ุงูุฏุงูุฉ ุงูููุญุฏุฉ
  if (this.isModelExcludedOrExhausted(modelName)) {
    console.log(`โ๏ธ [QUOTA-PRIORITY] ${modelName} ูุณุชููุฏ ุฃู ูุณุชุซูู - ุชุฎุทู`);
    continue;
  }
  
  // ...
}
```

#### ุงูุชุฃุซูุฑ ุงููุชููุน:
- โ **ุชุฒุงูู ุฃูุถู**: ูุธุงู ููุญุฏ ููุชุญูู ูู ุงูููุงุฐุฌ ุงููุณุชููุฏุฉ/ุงููุณุชุซูุงุฉ
- โ **ุฏูุฉ ุฃุนูู**: ูู ูุชู ุงุฎุชูุงุฑ ููุงุฐุฌ ูุณุชููุฏุฉ ุฃู ูุณุชุซูุงุฉ
- โ **ุตูุงูุฉ ุฃุณูู**: ูุธุงู ูุงุญุฏ ุจุฏูุงู ูู ูุธุงููู ูููุตููู
- โ **ุฃุฏุงุก ุฃูุถู**: ูุญุต ูุงุญุฏ ุจุฏูุงู ูู ูุญุตูู

---

### ุงููุดููุฉ 6: Cache TTL ูุตูุฑ ุฌุฏุงู (10 ุซูุงูู) โ (Medium Priority)

#### ุงููุตู:
- `quotaCache` ูู TTL 10 ุซูุงูู ููุท
- ูุฏ ูููู ูุตูุฑ ุฌุฏุงู ููุฃูุธูุฉ ุนุงููุฉ ุงูุงุณุชุฎุฏุงู
- ููู ุนูุฏ ุงูุชุญุฏูุซุ ูุง ูุชู invalidate ุงูู cache

#### ุงูููุฏ ุงูุญุงูู:
```javascript
// ุงูุณุทุฑ 21
this.quotaCache = new Map(); // Cache ููููุชุฉ ุงูุฅุฌูุงููุฉ ูุน TTL 10 ุซูุงูู

// ุงูุณุทุฑ 1503
if (cached && (now - cached.timestamp) < 10000) { // โ 10 ุซูุงูู ููุท!
  console.log(`โ [QUOTA-CACHE] ุงุณุชุฎุฏุงู Cache ููููุชุฉ: ${modelName} (${companyId})`);
  return cached.data;
}
```

#### ุงููุดููุฉ:
- TTL 10 ุซูุงูู ูุฏ ูููู ูุตูุฑ ุฌุฏุงู
- ููู ุนูุฏ `updateModelUsage`ุ ูุง ูุชู invalidate ุงูู cache
- ูุฏ ูุคุฏู ุฅูู ุงุณุชุฎุฏุงู ููุชุฉ ูุฏููุฉ

#### ุงูุญู ุงูููุชุฑุญ:
```javascript
// 1. ุฒูุงุฏุฉ TTL ุฅูู 30-60 ุซุงููุฉ
const QUOTA_CACHE_TTL = 30000; // โ 30 ุซุงููุฉ ุจุฏูุงู ูู 10

async calculateTotalQuota(modelName, companyId) {
  const cacheKey = `${modelName}_${companyId}`;
  const cached = this.quotaCache.get(cacheKey);
  const now = Date.now();
  
  if (cached && (now - cached.timestamp) < QUOTA_CACHE_TTL) {
    return cached.data;
  }
  
  // ...
}

// 2. Invalidate cache ุนูุฏ ุชุญุฏูุซ ุงูุงุณุชุฎุฏุงู
async updateModelUsage(modelId, totalTokenCount = 0) {
  // ... ุชุญุฏูุซ ุงูุงุณุชุฎุฏุงู ...
  
  // โ Invalidate cache ุจุนุฏ ุงูุชุญุฏูุซ
  const modelRecord = await this.prisma.geminiKeyModel.findUnique({
    where: { id: modelId },
    include: { key: true }
  });
  
  if (modelRecord) {
    const cacheKey = `${modelRecord.model}_${modelRecord.key.companyId || 'null'}`;
    this.quotaCache.delete(cacheKey); // โ Invalidate cache
    
    // โ ุฃูุถุงู invalidate cache ููููุงุชูุญ ุงููุฑูุฒูุฉ
    const centralCacheKey = `${modelRecord.model}_null`;
    this.quotaCache.delete(centralCacheKey);
  }
  
  // ...
}
```

#### ุงูุชุฃุซูุฑ ุงููุชููุน:
- โ **ุฃุฏุงุก ุฃูุถู**: TTL ุฃุทูู = cache hits ุฃูุซุฑ
- โ **ุฏูุฉ ุฃุนูู**: Invalidate ุนูุฏ ุงูุชุญุฏูุซ ูุถูู ุจูุงูุงุช ุญุฏูุซุฉ
- โ **ุชูุงุฒู ุฌูุฏ**: TTL 30 ุซุงููุฉ ููุงุฒู ุจูู ุงูุฃุฏุงุก ูุงูุฏูุฉ
- โ **ุชูููู ุงุณุชุนูุงูุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช**: cache hits ุฃูุซุฑ

---

### ุงููุดููุฉ 7: ุนุฏู ูุฌูุฏ ุญุฏ ุฃูุตู ูููุญุงููุงุช โ (High Priority)

#### ุงููุตู:
- ูุง ููุฌุฏ ุญุฏ ุฃูุตู ุนุงููู ูููุญุงููุงุช
- ูู ุฏุงูุฉ ููุง `maxRetries` ูุญูู (2 ุฃู 3)
- ูุง ููุฌุฏ ุชุชุจุน ุนุงููู ูููุญุงููุงุช
- ูุฏ ูุคุฏู ุฅูู ุญููุงุช ูุง ููุงุฆูุฉ ูู ุญุงูุงุช ูุนููุฉ

#### ุงูููุฏ ุงูุญุงูู:
```javascript
// responseGenerator.js - ุงูุณุทุฑ 1778
const maxRetries = 2; // โ ูุญูู ููุท

// aiConstants.js - ุงูุณุทุฑ 27
MAX_RETRIES: 2, // โ ูุญูู ููุท

// โ ูุง ููุฌุฏ ุญุฏ ุฃูุตู ุนุงููู ูููุญุงููุงุช ุงููููุฉ
// โ ูุง ููุฌุฏ ุชุชุจุน ูููุญุงููุงุช ุนุจุฑ ุงูุฏูุงู ุงููุฎุชููุฉ
```

#### ุงููุดููุฉ:
- ูุง ููุฌุฏ ุญุฏ ุฃูุตู ูููุญุงููุงุช ุงููููุฉ
- ูุฏ ูุชู ุชุฌุฑุจุฉ ููุณ ุงูููุงุฐุฌ ุนุฏุฉ ูุฑุงุช
- ูุฏ ูุคุฏู ุฅูู ุญููุงุช ูุง ููุงุฆูุฉ

#### ุงูุญู ุงูููุชุฑุญ:
```javascript
// 1. ุฅุถุงูุฉ ุญุฏ ุฃูุตู ุนุงููู ูู aiConstants.js
const DEFAULT_AI_SETTINGS = {
  MAX_RETRIES: 2,
  MAX_GLOBAL_ATTEMPTS: 4, // โ ุญุฏ ุฃูุตู ุนุงููู ูููุญุงููุงุช
  MAX_MODEL_SWITCHES: 3, // โ ุญุฏ ุฃูุตู ูุนุฏุฏ ุงูุชุจุฏููุงุช ุจูู ุงูููุงุฐุฌ
};

// 2. ุฅุถุงูุฉ ุชุชุจุน ูููุญุงููุงุช ูู responseGenerator.js
async generateAIResponse(prompt, conversationMemory, useRAG, providedGeminiConfig, companyId, conversationId, messageContext) {
  // โ ุชุชุจุน ุงููุญุงููุงุช
  const attemptContext = messageContext?.attemptContext || {
    totalAttempts: 0,
    modelSwitches: 0,
    triedModels: new Set(),
    triedKeys: new Set()
  };
  
  // โ ุงูุชุญูู ูู ุงูุญุฏ ุงูุฃูุตู
  if (attemptContext.totalAttempts >= DEFAULT_AI_SETTINGS.MAX_GLOBAL_ATTEMPTS) {
    console.error(`โ [MAX-ATTEMPTS] ุชู ุชุฌุงูุฒ ุงูุญุฏ ุงูุฃูุตู ูููุญุงููุงุช: ${attemptContext.totalAttempts}`);
    return { content: null, silentReason: 'ุชู ุชุฌุงูุฒ ุงูุญุฏ ุงูุฃูุตู ูููุญุงููุงุช' };
  }
  
  if (attemptContext.modelSwitches >= DEFAULT_AI_SETTINGS.MAX_MODEL_SWITCHES) {
    console.error(`โ [MAX-SWITCHES] ุชู ุชุฌุงูุฒ ุงูุญุฏ ุงูุฃูุตู ููุชุจุฏููุงุช: ${attemptContext.modelSwitches}`);
    return { content: null, silentReason: 'ุชู ุชุฌุงูุฒ ุงูุญุฏ ุงูุฃูุตู ููุชุจุฏููุงุช ุจูู ุงูููุงุฐุฌ' };
  }
  
  try {
    // ... ูุญุงููุฉ ุชูููุฏ ุงูุฑุฏ ...
  } catch (error) {
    // โ ุชุญุฏูุซ ุนุฏุงุฏ ุงููุญุงููุงุช
    attemptContext.totalAttempts++;
    
    if (is503Error) {
      attemptContext.modelSwitches++;
      const backupModel = await this.aiAgentService.findNextAvailableModel(companyId, {
        excludeModels: Array.from(attemptContext.triedModels),
        excludeModelKeys: Array.from(attemptContext.triedKeys)
      });
      
      if (backupModel) {
        attemptContext.triedModels.add(backupModel.model);
        attemptContext.triedKeys.add(backupModel.keyId);
        
        // โ ุฅุนุงุฏุฉ ุงููุญุงููุฉ ูุน attemptContext ูุญุฏุซ
        return await this.generateAIResponse(
          prompt,
          conversationMemory,
          useRAG,
          providedGeminiConfig,
          companyId,
          conversationId,
          { ...messageContext, attemptContext }
        );
      }
    }
  }
}
```

#### ุงูุชุฃุซูุฑ ุงููุชููุน:
- โ **ููุน ุงูุญููุงุช ุงููุงููุงุฆูุฉ**: ุญุฏ ุฃูุตู ูุงุถุญ ูููุญุงููุงุช
- โ **ุชูููุฑ ุงูููุงุฑุฏ**: ููุน ุงุณุชููุงู ุบูุฑ ุถุฑูุฑู ููููุงุฑุฏ
- โ **ุชุญุณูู ุงูุฃุฏุงุก**: ุฅููุงู ุงููุญุงููุงุช ุบูุฑ ุงููุฌุฏูุฉ ูุจูุฑุงู
- โ **ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุฃูุถู**: ุฅููุงู ุงููุญุงููุงุช ุจุนุฏ ุญุฏ ูุนููู

---

### ุงููุดููุฉ 8: selectBestModelByPriority ุฏุงุฆูุงู ูุฎุชุงุฑ ุงูุฃูู โ (Critical)

#### ุงููุตู:
- `selectBestModelByPriority` ุฏุงุฆูุงู ูุฎุชุงุฑ ุฃูู ูููุฐุฌ (ุฃุนูู ุฃููููุฉ)
- ูุง ููุฌุฏ Round-Robin ูุนูู
- ุงููุชูุฌุฉ: ุงูููุชุงุญ ุงูุฃูู ูุณุชููุฏ ุจุณุฑุนุฉ ุจูููุง ุงูููุงุชูุญ ุงูุฃุฎุฑู ูุงุฑุบุฉ

#### ุงูููุฏ ุงูุญุงูู:
```javascript
// backend/services/aiAgent/modelManager.js - ุงูุณุทุฑ 1716-1738
async selectBestModelByPriority(availableModels) {
  // ุงูููุงุฐุฌ ุฌุงูุฉ ูุฑุชุจุฉ ุญุณุจ ุงูุฃููููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
  // ุฃูู ูููุฐุฌ = ุฃุนูู ุฃููููุฉ (ุฃูู ุฑูู)
  const selectedModel = availableModels[0]; // โ ุฏุงุฆูุงู ุฃูู ูููุฐุฌ!
  
  await this.updateModelLastUsed(selectedModel.id, selectedModel.keyId);
  
  return selectedModel;
}
```

#### ุงููุดููุฉ:
- ูุง ููุฌุฏ Round-Robin ูุนูู
- ุงูููุชุงุญ ุงูุฃูู ูุณุชููุฏ ุจุณุฑุนุฉ
- ุนุฏู ุงูุงุณุชูุงุฏุฉ ูู ุงูุณุนุฉ ุงูุฅุฌูุงููุฉ

#### ุงูุญู ุงูููุชุฑุญ:
```javascript
async selectBestModelByPriority(availableModels, options = {}) {
  try {
    if (availableModels.length === 0) {
      return null;
    }
    
    // โ ุชุฌููุน ุงูููุงุฐุฌ ุญุณุจ ุงูุฃููููุฉ
    const modelsByPriority = {};
    for (const model of availableModels) {
      const priority = model.key.priority;
      if (!modelsByPriority[priority]) {
        modelsByPriority[priority] = [];
      }
      modelsByPriority[priority].push(model);
    }
    
    // โ ุงุฎุชูุงุฑ ุฃููููุฉ ุฃุนูู (ุฃูู ุฑูู)
    const priorities = Object.keys(modelsByPriority).map(Number).sort((a, b) => a - b);
    
    for (const priority of priorities) {
      const models = modelsByPriority[priority];
      
      // โ Round-Robin ุนูู ุงูููุงุฐุฌ ูู ููุณ ุงูุฃููููุฉ
      let selectedIndex = 0;
      
      if (this.lastUsedGlobalKeyId) {
        // โ ุงูุจุญุซ ุนู ุขุฎุฑ ููุชุงุญ ูุณุชุฎุฏู ูู ูุฐู ุงูุฃููููุฉ
        const lastIndex = models.findIndex(m => m.keyId === this.lastUsedGlobalKeyId);
        if (lastIndex >= 0) {
          // โ ุงุฎุชูุงุฑ ุงูููุชุงุญ ุงูุชุงูู (Round-Robin)
          selectedIndex = (lastIndex + 1) % models.length;
        } else {
          // โ ุฅุฐุง ูู ููู ุขุฎุฑ ููุชุงุญ ูู ูุฐู ุงูุฃููููุฉุ ุงุณุชุฎุฏู Round-Robin ุจูุงุกู ุนูู lastUsed
          const sortedByLastUsed = models.sort((a, b) => {
            const aLastUsed = a.lastUsed ? new Date(a.lastUsed).getTime() : 0;
            const bLastUsed = b.lastUsed ? new Date(b.lastUsed).getTime() : 0;
            return aLastUsed - bLastUsed;
          });
          selectedIndex = 0; // ุฃูู ูููุฐุฌ ูู ููุณุชุฎุฏู ูุคุฎุฑุงู
        }
      }
      
      const selectedModel = models[selectedIndex];
      this.lastUsedGlobalKeyId = selectedModel.keyId;
      
      await this.updateModelLastUsed(selectedModel.id, selectedModel.keyId);
      
      console.log(`๐ [ROUND-ROBIN] ุงุฎุชูุงุฑ ุงูููุชุงุญ: ${selectedModel.key.name} (Priority: ${priority}, Index: ${selectedIndex}/${models.length}) ูู ${availableModels.length} ููุงุชูุญ`);
      
      return selectedModel;
    }
    
    return null;
    
  } catch (error) {
    console.error('โ [MODEL-MANAGER] ุฎุทุฃ ูู Round-Robin Selection:', error);
    return availableModels.length > 0 ? availableModels[0] : null;
  }
}
```

#### ุงูุชุฃุซูุฑ ุงููุชููุน:
- โ **ุชูุฒูุน ูุชุณุงูู**: ุชูุฒูุน ุงูุงุณุชุฎุฏุงู ุจูู ุงูููุงุชูุญ ุจุดูู ูุชุณุงูู
- โ **ุงุณุชูุงุฏุฉ ุฃูุถู**: ุงูุงุณุชูุงุฏุฉ ูู ุงูุณุนุฉ ุงูุฅุฌูุงููุฉ ูุฌููุน ุงูููุงุชูุญ
- โ **ุฃุฏุงุก ุฃูุถู**: ุงูููุงุชูุญ ูู ุชุณุชููุฏ ุจุณุฑุนุฉ
- โ **ููุซูููุฉ ุฃุนูู**: ุชูุฒูุน ุงูุฃุญูุงู ูููู ูู ูุดู ุงูููุงุชูุญ

---

## ๐ ุงูุฃููููุงุช

### ุฃููููุฉ ุนุงููุฉ (ูุฌุจ ุฅุตูุงุญูุง ููุฑุงู):
1. โ **ุงููุดููุฉ 1: ุนุฏู ูุดุงุฑูุฉ triedModels ุจูู ุงูุฏูุงู** (Critical)
2. โ **ุงููุดููุฉ 2: findNextAvailableModel ูุง ูุณุชุซูู ุงูููุงุฐุฌ ุงููุฌุฑุจุฉ** (Critical)
3. โ **ุงููุดููุฉ 3: Race condition ูู markModelAsExhaustedFrom429** (Critical)
4. โ **ุงููุดููุฉ 8: selectBestModelByPriority ุฏุงุฆูุงู ูุฎุชุงุฑ ุงูุฃูู** (Critical)

### ุฃููููุฉ ูุชูุณุทุฉ (ูุฌุจ ุฅุตูุงุญูุง ูุฑูุจุงู):
5. โ **ุงููุดููุฉ 4: exhaustedModelsCache ูุง ูููุญุต ูู findBestModelByPriorityWithQuota** (High Priority)
6. โ **ุงููุดููุฉ 5: ุนุฏู ุชุฒุงูู ุจูู exhaustedModelsCache ู excludedModels** (High Priority)
7. โ **ุงููุดููุฉ 7: ุนุฏู ูุฌูุฏ ุญุฏ ุฃูุตู ูููุญุงููุงุช** (High Priority)

### ุฃููููุฉ ููุฎูุถุฉ (ูููู ุชุฃุฌูููุง):
8. โ **ุงููุดููุฉ 6: Cache TTL ูุตูุฑ ุฌุฏุงู** (Medium Priority)

---

## ๐จ ุงูุชุฃุซูุฑ ุงููุชููุน ุจุนุฏ ุงูุฅุตูุงุญ

### ูุจู ุงูุฅุตูุงุญ:
- โ ุนุฏู ูุดุงุฑูุฉ triedModels ุจูู ุงูุฏูุงู
- โ findNextAvailableModel ูุง ูุณุชุซูู ุงูููุงุฐุฌ ุงููุฌุฑุจุฉ
- โ Race conditions ูู ุชุญุฏูุซ ุงูุงุณุชุฎุฏุงู
- โ exhaustedModelsCache ูุง ูููุญุต ูู ุฌููุน ุงููุณุงุฑุงุช
- โ ุนุฏู ุชุฒุงูู ุจูู exhaustedModelsCache ู excludedModels
- โ Cache TTL ูุตูุฑ ุจุฏูู invalidate
- โ ูุง ููุฌุฏ ุญุฏ ุฃูุตู ูููุญุงููุงุช
- โ Priority-First ููุท ุจุฏูู Round-Robin

### ุจุนุฏ ุงูุฅุตูุงุญ:
- โ ูุดุงุฑูุฉ triedModels ุจูู ุฌููุน ุงูุฏูุงู
- โ findNextAvailableModel ูุณุชุซูู ุงูููุงุฐุฌ ุงููุฌุฑุจุฉ
- โ ูุง Race conditions - ุชุญุฏูุซ ููุฑู ูู cache
- โ exhaustedModelsCache ูููุญุต ูู ุฌููุน ุงููุณุงุฑุงุช
- โ ุชุฒุงูู ุจูู exhaustedModelsCache ู excludedModels
- โ Cache TTL ูุญุณูู ูุน invalidate ุนูุฏ ุงูุชุญุฏูุซ
- โ ุญุฏ ุฃูุตู ูุงุถุญ ูููุญุงููุงุช
- โ Round-Robin ูุนูู ูุน ูุฑุงุนุงุฉ ุงูุฃููููุฉ
- โ ุชูุฒูุน ูุชุณุงูู ููุงุณุชุฎุฏุงู
- โ ุงุณุชูุงุฏุฉ ุฃูุถู ูู ุงูุณุนุฉ ุงูุฅุฌูุงููุฉ

---

## ๐ ุฎุทุฉ ุงูุชูููุฐ

### ุงููุฑุญูุฉ 1: ุงูุฅุตูุงุญุงุช ุงูุญุฑุฌุฉ (ุฃููููุฉ ุนุงููุฉ)
1. ุฅุตูุงุญ ุงููุดููุฉ 1: ุฅุถุงูุฉ excludeModels parameter
2. ุฅุตูุงุญ ุงููุดููุฉ 2: ุชุนุฏูู findNextAvailableModel
3. ุฅุตูุงุญ ุงููุดููุฉ 3: ุชุญุฏูุซ ููุฑู ูู cache
4. ุฅุตูุงุญ ุงููุดููุฉ 8: ุชุทุจูู Round-Robin ูุนูู

### ุงููุฑุญูุฉ 2: ุงูุฅุตูุงุญุงุช ุนุงููุฉ ุงูุฃููููุฉ
5. ุฅุตูุงุญ ุงููุดููุฉ 4: ุฅุถุงูุฉ ูุญุต exhaustedModelsCache
6. ุฅุตูุงุญ ุงููุดููุฉ 5: ุชูุญูุฏ ุงููุธุงู
7. ุฅุตูุงุญ ุงููุดููุฉ 7: ุฅุถุงูุฉ ุญุฏ ุฃูุตู ูููุญุงููุงุช

### ุงููุฑุญูุฉ 3: ุงูุฅุตูุงุญุงุช ูุชูุณุทุฉ ุงูุฃููููุฉ
8. ุฅุตูุงุญ ุงููุดููุฉ 6: ุชุญุณูู Cache TTL

---

**ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุฑูุฑ ุจูุงุณุทุฉ:** AI Assistant  
**ุงูุชุงุฑูุฎ:** $(date)

