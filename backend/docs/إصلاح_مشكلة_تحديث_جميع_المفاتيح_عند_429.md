# ๐ง ุฅุตูุงุญ ูุดููุฉ ุชุญุฏูุซ ุฌููุน ุงูููุงุชูุญ ุนูุฏ ุญุฏูุซ 429

**ุชุงุฑูุฎ ุงูุฅุตูุงุญ:** 2025-11-28  
**ุงููุดููุฉ:** ุนูุฏ ุญุฏูุซ ุฎุทุฃ 429 ูู ููุชุงุญ ูุงุญุฏุ ูุชู ุชุญุฏูุซ ุฌููุน ุงูููุงุฐุฌ ุจูุฐุง ุงูุงุณู ุจุฏูุงู ูู ุงูููุชุงุญ ุงููุญุฏุฏ ููุท.

---

## ๐ ุงููุดููุฉ

### ุงููุตู:
ุนูุฏ ุญุฏูุซ ุฎุทุฃ 429 (Too Many Requests) ูู ููุชุงุญ ูุงุญุฏ (ูุซู `superadmin`)ุ ูุชู ุงุณุชุฏุนุงุก `markModelAsExhaustedFrom429` ุงูุชู ุชุญุฏุซ **ุฌููุน** ุงูููุงุฐุฌ ุจูุฐุง ุงูุงุณู ูู ุงูุดุฑูุฉุ ูููุณ ููุท ุงูููุชุงุญ ุงููุญุฏุฏ ุงูุฐู ูุดู.

### ูุซุงู ูู ุงูู Logs:
```
โ [AI-RESPONSE] ุฎุทุฃ ูู ุชูููุฏ ุงูุฑุฏ - ุงูุฎุทุฃ: [429 Too Many Requests]
โ๏ธ [QUOTA-EXHAUSTED] Marked model gemini-2.5-flash as exhausted (quota: 250000)
```

**ุงููุดููุฉ:** ูุชู ุชุญุฏูุซ ุฌููุน ุงูููุงุชูุญ ุงูุชู ุชุญุชูู ุนูู `gemini-2.5-flash`ุ ูููุณ ููุท `superadmin`.

---

## ๐ ุงูุณุจุจ

### ุงูููุฏ ุงููุฏูู:
```javascript
async markModelAsExhaustedFrom429(modelName, quotaValue, companyId = null) {
  // ุงูุจุญุซ ุนู ุฌููุน ุงูููุงุฐุฌ ุงูุชู ุชุญูู ููุณ ุงูุงุณู
  const modelRecords = await this.prisma.geminiKeyModel.findMany({
    where: { model: modelName, ... }
  });
  
  // ุชุญุฏูุซ ุฌููุน ุงูููุงุฐุฌ
  for (const modelRecord of modelRecords) {
    // ุชุญุฏูุซ ุงูุงุณุชุฎุฏุงู...
  }
}
```

**ุงููุดููุฉ:** ูุง ููุฌุฏ ุทุฑููุฉ ูุชุญุฏูุฏ ุงูููุชุงุญ ุงููุญุฏุฏ ุงูุฐู ูุดู.

---

## โ ุงูุญู

### 1. ุฅุถุงูุฉ ูุนุงูู `modelId` ุฅูู `markModelAsExhaustedFrom429`:

```javascript
async markModelAsExhaustedFrom429(modelName, quotaValue, companyId = null, modelId = null) {
  // โ ุฅุฐุง ุชู ุชูุฑูุฑ modelIdุ ูุญุฏุซ ููุท ูุฐุง ุงููููุฐุฌ ุงููุญุฏุฏ
  let modelRecords;
  
  if (modelId) {
    // ุชุญุฏูุซ ููุท ุงููููุฐุฌ ุงููุญุฏุฏ
    const modelRecord = await this.prisma.geminiKeyModel.findUnique({
      where: { id: modelId },
      include: { key: true }
    });
    modelRecords = modelRecord ? [modelRecord] : [];
  } else {
    // ุงูุจุญุซ ุนู ุฌููุน ุงูููุงุฐุฌ (ููุชูุงูู ูุน ุงูููุฏ ุงููุฏูู)
    modelRecords = await this.prisma.geminiKeyModel.findMany({
      where: { model: modelName, ... }
    });
  }
  
  // ุชุญุฏูุซ ููุท ุงูููุงุฐุฌ ุงููุชุฃุซุฑุฉ
  for (const modelRecord of modelRecords) {
    // ุชุญุฏูุซ ุงูุงุณุชุฎุฏุงู...
  }
}
```

### 2. ุชุญุฏูุซ ุงูุงุณุชุฏุนุงุกุงุช ูู `responseGenerator.js`:

#### ุฃ. ุนูุฏ ุญุฏูุซ 429 ูู ุงููููุฐุฌ ุงูุฃุณุงุณู:
```javascript
if (modelName) {
  const modelId = currentGeminiConfig?.modelId || null;
  await this.aiAgentService.markModelAsExhaustedFrom429(modelName, quotaValue, companyId, modelId);
  if (modelId) {
    console.log(`โ๏ธ [QUOTA-EXHAUSTED] Marked model ${modelName} (modelId: ${modelId}) as exhausted`);
  }
}
```

#### ุจ. ุนูุฏ ุญุฏูุซ 429 ูู ุงููููุฐุฌ ุงูุจุฏูู:
```javascript
if (modelName) {
  const modelId = backupModel?.modelId || null;
  await this.aiAgentService.markModelAsExhaustedFrom429(modelName, quotaValue, companyId, modelId);
  if (modelId) {
    console.log(`โ๏ธ [QUOTA-EXHAUSTED] Marked backup model ${modelName} (modelId: ${modelId}) as exhausted`);
  }
}
```

---

## ๐ ุงูุชุฃุซูุฑ

### ูุจู ุงูุฅุตูุงุญ:
- ุนูุฏ ูุดู ููุชุงุญ `superadmin` ุจู 429ุ ูุชู ุชุญุฏูุซ **ุฌููุน** ุงูููุงุชูุญ ุงูุชู ุชุญุชูู ุนูู `gemini-2.5-flash`
- ูุฏ ูุชู ุงุณุชุซูุงุก ููุงุชูุญ ุฃุฎุฑู ุจุดูู ุบูุฑ ุตุญูุญ
- ูุฏ ูุชู ููุฏุงู ููุงุชูุญ ูุชุงุญุฉ

### ุจุนุฏ ุงูุฅุตูุงุญ:
- ุนูุฏ ูุดู ููุชุงุญ `superadmin` ุจู 429ุ ูุชู ุชุญุฏูุซ **ููุท** ููุชุงุญ `superadmin`
- ุงูููุงุชูุญ ุงูุฃุฎุฑู ุชุจูู ูุชุงุญุฉ ููุงุณุชุฎุฏุงู
- ุงููุธุงู ููููู ุงูุงุณุชูุฑุงุฑ ูู ุงุณุชุฎุฏุงู ุงูููุงุชูุญ ุงูุฃุฎุฑู

---

## โ ุงูุชุญูู

### ุงูู Logs ุงููุชููุนุฉ ุจุนุฏ ุงูุฅุตูุงุญ:
```
โ [AI-RESPONSE] ุฎุทุฃ ูู ุชูููุฏ ุงูุฑุฏ - ุงูุฎุทุฃ: [429 Too Many Requests]
โ๏ธ [QUOTA-EXHAUSTED] Marked model gemini-2.5-flash (modelId: cumb939lxsm) as exhausted (quota: 250000)
โ๏ธ [QUOTA-EXHAUSTED] Updated model gemini-2.5-flash (cumb939lxsm) in key superadmin - Used: 250000/250000
โ [FIX-4] Added gemini-2.5-flash to excludedModels (key: superadmin)
โ [QUOTA-PRIORITY] ุชู ุงุฎุชูุงุฑ ุงููููุฐุฌ: gemini-2.5-flash (Key: com, Priority: 1)
```

**ุงูููุงุญุธุงุช:**
- ูุชู ุชุญุฏูุซ ููุท `superadmin` (modelId: cumb939lxsm)
- ูุชู ุงุณุชุซูุงุก ููุท `superadmin`
- ุงููุธุงู ูุฌุฏ ููุชุงุญ ุขุฎุฑ (`com`) ููุณุชุฎุฏูู ุจูุฌุงุญ

---

## ๐ฏ ุงูุฎูุงุตุฉ

### ุงููุดููุฉ:
- ุชุญุฏูุซ ุฌููุน ุงูููุงุชูุญ ุนูุฏ ูุดู ููุชุงุญ ูุงุญุฏ ุจู 429

### ุงูุญู:
- ุฅุถุงูุฉ ูุนุงูู `modelId` ูุชุญุฏูุฏ ุงูููุชุงุญ ุงููุญุฏุฏ
- ุชุญุฏูุซ ููุท ุงูููุชุงุญ ุงููุญุฏุฏ ุงูุฐู ูุดู

### ุงูุชุฃุซูุฑ:
- โ ุฏูุฉ ุฃุนูู ูู ุชุญุฏูุซ ุงูุงุณุชุฎุฏุงู
- โ ุนุฏู ููุฏุงู ููุงุชูุญ ูุชุงุญุฉ
- โ ุชุญุณูู ุงูุฃุฏุงุก ูุงูููุซูููุฉ

---

**ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุฑูุฑ ุจูุงุณุทุฉ:** AI Assistant  
**ุงูุชุงุฑูุฎ:** 2025-11-28

