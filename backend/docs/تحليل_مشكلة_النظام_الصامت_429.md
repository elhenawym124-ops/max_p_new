# ๐ ุชุญููู ููุตู - ูุดููุฉ ุงููุธุงู ุงูุตุงูุช ุนูุฏ ูุดู ุงููููุฐุฌ ุงูุจุฏูู ุจู 429

**ุชุงุฑูุฎ ุงูุชุญููู:** $(date)  
**ุงููููุงุช ุงูููุญูุตุฉ:**
- `backend/services/aiAgent/responseGenerator.js`
- `backend/aiAgentService.js`
- `backend/services/responseGenerator.js`

---

## ๐ ููุฎุต ุงููุดููุฉ

### ุงูุณููุงุฑูู:
1. โ ุงููููุฐุฌ ุงูุฃุณุงุณู ูุดู ุจู **503** (Service Unavailable)
2. โ ุงููุธุงู ุญุงูู ุงูุชุจุฏูู ุฅูู **ูููุฐุฌ ุจุฏูู**
3. โ ุงููููุฐุฌ ุงูุจุฏูู ูุดู ุจู **429** (Too Many Requests - ุชุฌุงูุฒ ุงูุญุตุฉ)
4. โ ุงููุธุงู ุญุงูู ุงูุจุญุซ ุนู **ูููุฐุฌ ุจุฏูู ุซุงูู** ููู ูุดู
5. โ **ุงููุชูุฌุฉ: ุงููุธุงู ุตุงูุช - ูู ูุชู ุฅุฑุณุงู ุฑุฏ ููุนููู**

---

## ๐ ุงููุดุงูู ุงูููุชุดูุฉ

### 1. โ **ุนุฏู ุชุญุฏูุฏ ุงููููุฐุฌ ุงูุจุฏูู ููุณุชููุฏ ูุจู ุงูุจุญุซ ุนู ูููุฐุฌ ุซุงูู (Critical)**

**ุงููุดููุฉ:**
- ุนูุฏูุง ููุดู ุงููููุฐุฌ ุงูุจุฏูู ุจู 429ุ ูุง ูุชู ุงุณุชุฏุนุงุก `markModelAsExhaustedFrom429`
- ูุฐููุ `findNextAvailableModel` ูุฏ ูุนูุฏ ููุณ ุงููููุฐุฌ ุฃู ูููุฐุฌ ุขุฎุฑ ูููู ูุณุชููุฏ ุฃูุถุงู

**ุงูููุฏ ุงูุญุงูู:**
```javascript
// ุงูุณุทุฑ 1813-1826
} catch (retryError) {
  console.error('โ [503-FALLBACK] Backup model also failed:', retryError.message);
  
  const is429Error = retryError.status === 429 || ...
  
  if (is429Error) {
    // โ ูุง ูุชู ุชุญุฏูุฏ ุงููููุฐุฌ ุงูุจุฏูู ููุณุชููุฏ ููุง!
    const secondBackupModel = await this.aiAgentService.findNextAvailableModel(companyId);
    // ูุฏ ูุนูุฏ ููุณ ุงููููุฐุฌ ุฃู ูููุฐุฌ ูุณุชููุฏ!
  }
}
```

**ุงูุชุฃุซูุฑ:**
- `findNextAvailableModel` ูุฏ ูุนูุฏ ููุณ ุงููููุฐุฌ ุงูุฐู ูุดู ููุชู
- ูุฏ ูุนูุฏ ูููุฐุฌ ุขุฎุฑ ูููู ูุณุชููุฏ ุฃูุถุงู
- ููุฏุงู ุงูููุช ูู ูุญุงููุงุช ุบูุฑ ูุฌุฏูุฉ

---

### 2. โ **ุนุฏู ุงุณุชุซูุงุก ุงููููุฐุฌ ุงูุฃุณุงุณู ูู ุงูุจุญุซ (High Priority)**

**ุงููุดููุฉ:**
- ุงููููุฐุฌ ุงูุฃุณุงุณู ุงูุฐู ูุดู ุจู 503 ูุง ูุชู ุงุณุชุซูุงุคู ูู ุงูุจุญุซ
- `findNextAvailableModel` ูุฏ ูุนูุฏ ููุณ ุงููููุฐุฌ ุงูุฃุณุงุณู

**ุงูุชุฃุซูุฑ:**
- ูุญุงููุงุช ุบูุฑ ูุฌุฏูุฉ ูุน ุงููููุฐุฌ ุงูุฃุณุงุณู ุงูุฐู ูุดู ููุชู

---

### 3. โ **ุนุฏู ุชุชุจุน ุงูููุงุฐุฌ ุงูุชู ุชู ุชุฌุฑุจุชูุง (High Priority)**

**ุงููุดููุฉ:**
- ูุง ุชูุฌุฏ ูุงุฆูุฉ ุจุงูููุงุฐุฌ ุงูุชู ุชู ุชุฌุฑุจุชูุง ุจุงููุนู ูู ูุฐู ุงูุฌูุณุฉ
- ูุฏ ูุชู ุชุฌุฑุจุฉ ููุณ ุงููููุฐุฌ ุนุฏุฉ ูุฑุงุช

**ุงูุชุฃุซูุฑ:**
- ููุฏุงู ุงูููุช ูู ูุญุงููุงุช ููุฑุฑุฉ
- ุงุณุชููุงู tokens ุบูุฑ ุถุฑูุฑู

---

### 4. โ **ุนุฏู ูุฌูุฏ fallback message ููุนููู (Medium Priority)**

**ุงููุดููุฉ:**
- ุนูุฏูุง ุชูุดู ุฌููุน ุงูููุงุฐุฌุ ุงููุธุงู ุตุงูุช ุชูุงูุงู
- ูุง ูุชู ุฅุฑุณุงู ุฃู ุฑุณุงูุฉ ููุนููู ุชูุถุญ ุงููุดููุฉ

**ุงูุชุฃุซูุฑ:**
- ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุณูุฆุฉ
- ุงูุนููู ูุง ูุนุฑู ูุง ุญุฏุซ
- ููุฏุงู ุงูุซูุฉ ูู ุงููุธุงู

---

### 5. โ **ุนุฏู ุงุณุชุฎุฑุงุฌ ูุนูููุงุช 429 ูู ุงููููุฐุฌ ุงูุจุฏูู (Medium Priority)**

**ุงููุดููุฉ:**
- ุนูุฏูุง ููุดู ุงููููุฐุฌ ุงูุจุฏูู ุจู 429ุ ูุง ูุชู ุงุณุชุฎุฑุงุฌ `modelName` ู `quotaValue` ูู ุงูุฎุทุฃ
- ูุฐูู ูุง ูููู ุชุญุฏูุฏ ุงููููุฐุฌ ููุณุชููุฏ ุจุดูู ุฏููู

**ุงูููุฏ ุงูุญุงูู:**
```javascript
// ุงูุณุทุฑ 1813-1823
} catch (retryError) {
  const is429Error = retryError.status === 429 || ...
  
  if (is429Error) {
    // โ ูุง ูุชู ุงุณุชุฎุฑุงุฌ modelName ู quotaValue ูู retryError
    // โ ูุง ูุชู ุงุณุชุฏุนุงุก markModelAsExhaustedFrom429
  }
}
```

**ุงูุชุฃุซูุฑ:**
- ูุง ูุชู ุชุญุฏูุซ ุญุงูุฉ ุงููููุฐุฌ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ูุฏ ูุชู ุงุณุชุฎุฏุงู ุงููููุฐุฌ ุงููุณุชููุฏ ูุฑุฉ ุฃุฎุฑู

---

## ๐ฏ ุงูุญููู ุงูููุชุฑุญุฉ

### 1. โ **ุชุญุฏูุฏ ุงููููุฐุฌ ุงูุจุฏูู ููุณุชููุฏ ูุจู ุงูุจุญุซ ุนู ูููุฐุฌ ุซุงูู (Critical)**

```javascript
if (is429Error) {
  // โ ุงุณุชุฎุฑุงุฌ ูุนูููุงุช 429 ูู ุงูุฎุทุฃ
  let quotaValue = null;
  let modelName = backupModel.model; // ุงุณุชุฎุฏุงู ุงููููุฐุฌ ุงูุจุฏูู ุงูุฐู ูุดู
  
  try {
    const errorDetails = retryError.errorDetails || [];
    for (const detail of errorDetails) {
      if (detail['@type'] === 'type.googleapis.com/google.rpc.QuotaFailure') {
        const violations = detail.violations || [];
        for (const violation of violations) {
          if (violation.quotaValue) {
            quotaValue = violation.quotaValue;
          }
          if (violation.quotaDimensions && violation.quotaDimensions.model) {
            modelName = violation.quotaDimensions.model;
          }
        }
      }
    }
  } catch (parseError) {
    console.warn('โ๏ธ [429-ERROR] Could not parse error details:', parseError);
  }
  
  // โ ุชุญุฏูุฏ ุงููููุฐุฌ ุงูุจุฏูู ููุณุชููุฏ
  if (modelName) {
    await this.aiAgentService.markModelAsExhaustedFrom429(modelName, quotaValue, companyId);
    console.log(`โ๏ธ [QUOTA-EXHAUSTED] Marked backup model ${modelName} as exhausted`);
  }
  
  // โ ุงูุขู ุงูุจุญุซ ุนู ูููุฐุฌ ุซุงูู (ุณูุณุชุซูู ุงููููุฐุฌ ุงููุณุชููุฏ)
  const secondBackupModel = await this.aiAgentService.findNextAvailableModel(companyId);
  // ...
}
```

---

### 2. โ **ุฅุถุงูุฉ ูุงุฆูุฉ ุจุงูููุงุฐุฌ ุงูุชู ุชู ุชุฌุฑุจุชูุง (High Priority)**

```javascript
// ูู ุจุฏุงูุฉ generateAIResponse
const triedModels = new Set();
if (providedGeminiConfig?.model) {
  triedModels.add(providedGeminiConfig.model);
}

// ุนูุฏ ูุดู ุงููููุฐุฌ ุงูุฃุณุงุณู ุจู 503
if (is503Error) {
  if (geminiConfig?.model) {
    triedModels.add(geminiConfig.model);
  }
  
  const backupModel = await this.aiAgentService.findNextAvailableModel(companyId, {
    excludeModels: Array.from(triedModels)
  });
  // ...
}

// ุนูุฏ ูุดู ุงููููุฐุฌ ุงูุจุฏูู ุจู 429
if (is429Error) {
  triedModels.add(backupModel.model);
  
  const secondBackupModel = await this.aiAgentService.findNextAvailableModel(companyId, {
    excludeModels: Array.from(triedModels)
  });
  // ...
}
```

---

### 3. โ **ุฅุถุงูุฉ fallback message ููุนููู (Medium Priority)**

```javascript
// ุฅุฐุง ูุดูุช ุฌููุน ุงูููุงุฐุฌ
if (!secondBackupModel || secondBackupModel.model === backupModel.model) {
  // โ ุฅุฑุณุงู ุฑุณุงูุฉ ุฎุทุฃ ููุนููู ุจุฏูุงู ูู ุงูุตูุช
  return {
    content: "ุนุฐุฑุงูุ ููุงุฌู ุตุนูุจุฉ ุชูููุฉ ูุคูุชุฉ ูู ูุนุงูุฌุฉ ุทูุจู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู ุจุนุฏ ููููุ ุฃู ุงูุชูุงุตู ูุนูุง ูุจุงุดุฑุฉ.",
    silentReason: null, // โ ููุณ ุตุงูุช - ุณูุชู ุฅุฑุณุงู ุงูุฑุณุงูุฉ
    errorType: 'all_models_failed',
    shouldEscalate: true // โ ูุฌุจ ุชุตุนูุฏ ููุฏุนู
  };
}
```

---

### 4. โ **ุชุญุณูู findNextAvailableModel ูุฏุนู ุงุณุชุซูุงุก ุงูููุงุฐุฌ (High Priority)**

```javascript
// ูู findNextAvailableModel
async findNextAvailableModel(companyId, options = {}) {
  const { excludeModels = [] } = options;
  
  // ... ุงูููุฏ ุงูุญุงูู ...
  
  for (const modelRecord of availableModels) {
    // โ ุงุณุชุซูุงุก ุงูููุงุฐุฌ ุงููุญุฏุฏุฉ
    if (excludeModels.includes(modelRecord.model)) {
      console.log(`โ๏ธ [FIND-NEXT] Excluding tried model: ${modelRecord.model}`);
      continue;
    }
    
    // ... ุจุงูู ุงูููุฏ ...
  }
}
```

---

### 5. โ **ุฅุถุงูุฉ retry loop ุฐูู ููุจุญุซ ุนู ููุงุฐุฌ ูุชุนุฏุฏุฉ (Medium Priority)**

```javascript
// ูุญุงููุฉ ุงูุจุญุซ ุนู ููุงุฐุฌ ูุชุนุฏุฏุฉ ุญุชู ูุฌุฏ ูุงุญุฏ ูุนูู
const maxModelAttempts = 3;
let lastError = null;

for (let modelAttempt = 0; modelAttempt < maxModelAttempts; modelAttempt++) {
  const backupModel = await this.aiAgentService.findNextAvailableModel(companyId, {
    excludeModels: Array.from(triedModels)
  });
  
  if (!backupModel) {
    break; // ูุง ุชูุฌุฏ ููุงุฐุฌ ูุชุงุญุฉ
  }
  
  if (triedModels.has(backupModel.model)) {
    continue; // ุชู ุชุฌุฑุจุฉ ูุฐุง ุงููููุฐุฌ ุจุงููุนู
  }
  
  triedModels.add(backupModel.model);
  
  try {
    // ูุญุงููุฉ ุงุณุชุฎุฏุงู ุงููููุฐุฌ
    const result = await model.generateContent(prompt);
    return result.response.text();
  } catch (error) {
    lastError = error;
    
    // ุฅุฐุง ูุงู 429ุ ุญุฏุฏ ุงููููุฐุฌ ููุณุชููุฏ
    if (error.status === 429 || error.message?.includes('429')) {
      await this.aiAgentService.markModelAsExhaustedFrom429(backupModel.model, null, companyId);
    }
    
    // ุงุณุชูุฑ ูู ุงููุญุงููุฉ ูุน ูููุฐุฌ ุขุฎุฑ
    continue;
  }
}

// ุฅุฐุง ูุดูุช ุฌููุน ุงููุญุงููุงุช
throw lastError || new Error('All backup models failed');
```

---

## ๐ ุงูุฃููููุงุช

### ุฃููููุฉ ุนุงููุฉ (ูุฌุจ ุฅุตูุงุญูุง ููุฑุงู):
1. โ **ุชุญุฏูุฏ ุงููููุฐุฌ ุงูุจุฏูู ููุณุชููุฏ ูุจู ุงูุจุญุซ ุนู ูููุฐุฌ ุซุงูู** (Critical)
2. โ **ุฅุถุงูุฉ ูุงุฆูุฉ ุจุงูููุงุฐุฌ ุงูุชู ุชู ุชุฌุฑุจุชูุง** (High Priority)
3. โ **ุชุญุณูู findNextAvailableModel ูุฏุนู ุงุณุชุซูุงุก ุงูููุงุฐุฌ** (High Priority)

### ุฃููููุฉ ูุชูุณุทุฉ (ูุฌุจ ุฅุตูุงุญูุง ูุฑูุจุงู):
4. โ **ุฅุถุงูุฉ fallback message ููุนููู** (Medium Priority)
5. โ **ุฅุถุงูุฉ retry loop ุฐูู ููุจุญุซ ุนู ููุงุฐุฌ ูุชุนุฏุฏุฉ** (Medium Priority)

### ุฃููููุฉ ููุฎูุถุฉ (ูููู ุชุฃุฌูููุง):
6. โ **ุชุญุณูู logging ู monitoring** (Low Priority)

---

## ๐จ ุงูุชุฃุซูุฑ ุงููุชููุน ุจุนุฏ ุงูุฅุตูุงุญ

### ูุจู ุงูุฅุตูุงุญ:
- โ ุงููุธุงู ุตุงูุช ุนูุฏ ูุดู ุงููููุฐุฌ ุงูุจุฏูู ุจู 429
- โ ูุฏ ูุชู ุชุฌุฑุจุฉ ููุณ ุงููููุฐุฌ ุนุฏุฉ ูุฑุงุช
- โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุณูุฆุฉ

### ุจุนุฏ ุงูุฅุตูุงุญ:
- โ ุงููุธุงู ุณูุญุงูู ุงูุจุญุซ ุนู ููุงุฐุฌ ุจุฏููุฉ ูุชุนุฏุฏุฉ
- โ ุงูููุงุฐุฌ ุงููุณุชููุฏุฉ ุณูุชู ุงุณุชุซูุงุคูุง ูู ุงูุจุญุซ
- โ ุฅุฐุง ูุดูุช ุฌููุน ุงูููุงุฐุฌุ ุณูุชู ุฅุฑุณุงู ุฑุณุงูุฉ ููุนููู
- โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุฃูุถู

---

**ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุฑูุฑ ุจูุงุณุทุฉ:** AI Assistant  
**ุงูุชุงุฑูุฎ:** $(date)

