# ๐ ูุญุต ุดุงูู - ุงุณุชุฎุฏุงู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ ูู ุฌููุน ุงููุณุงุฑุงุช

**ุชุงุฑูุฎ ุงููุญุต:** 2025-11-28  
**ุงููุฏู:** ุงูุชุฃูุฏ ูู ุฃู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ ุชูุณุชุฎุฏู ูู **ุฌููุน** ุงููุณุงุฑุงุช ุงูุชู ุชุจูู ุฑุฏูุฏ ููุนููุงุก

---

## โ ุงููุณุงุฑุงุช ุงูุชู ุชุณุชุฎุฏู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ

### 1. ุงููุณุงุฑ ุงูุฑุฆูุณู - `buildAdvancedPrompt` โ

**ุงููููุน:** `backend/services/aiAgent/responseGenerator.js` - ุงูุณุทุฑ 294  
**ุงูุงุณุชุฎุฏุงู:** `backend/services/aiAgent/messageProcessor.js` - ุงูุณุทุฑ 761

**ุงูุญุงูุฉ:** โ **ูุณุชุฎุฏู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ**

```javascript
// โ FIX: ุฅุถุงูุฉ ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ (Response Rules Checkpoints) - ููู ุฌุฏุงู!
console.log('๐ [RESPONSE-RULES] Checking for response rules...');
if (companyPrompts.responseRules) {
  try {
    const rules = typeof companyPrompts.responseRules === 'string' 
      ? JSON.parse(companyPrompts.responseRules) 
      : companyPrompts.responseRules;
    const rulesPrompt = buildPromptFromRules(rules);
    prompt += rulesPrompt;
  } catch (e) {
    prompt += buildPromptFromRules(getDefaultRules());
  }
} else {
  prompt += buildPromptFromRules(getDefaultRules());
}
```

**ุงูุชุฃุซูุฑ:** โ ุฌููุน ุงูุฑุฏูุฏ ุงูุนุงุฏูุฉ ุชุณุชุฎุฏู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ

---

### 2. ุงููุณุงุฑ ุงูุฃุณุงุณู - `buildPrompt` โ

**ุงููููุน:** `backend/services/aiAgent/responseGenerator.js` - ุงูุณุทุฑ 136  
**ุงูุงุณุชุฎุฏุงู:** `backend/services/aiAgent/messageProcessor.js` - ุงูุณุทุฑ 1606

**ุงูุญุงูุฉ:** โ **ูุณุชุฎุฏู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ**

```javascript
// โ ุฅุถุงูุฉ ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ (Response Rules Checkpoints)
if (companyPrompts.responseRules) {
  try {
    const rules = typeof companyPrompts.responseRules === 'string' 
      ? JSON.parse(companyPrompts.responseRules) 
      : companyPrompts.responseRules;
    prompt += buildPromptFromRules(rules);
  } catch (e) {
    prompt += buildPromptFromRules(getDefaultRules());
  }
} else {
  prompt += buildPromptFromRules(getDefaultRules());
}
```

**ุงูุชุฃุซูุฑ:** โ ุงููุณุงุฑ ุงูุจุฏูู (Pattern Application) ูุณุชุฎุฏู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ

---

### 3. ูุณุงุฑ Retry - `buildAdvancedPrompt` โ

**ุงููููุน:** `backend/services/aiAgent/messageProcessor.js` - ุงูุณุทุฑ 939

**ุงูุญุงูุฉ:** โ **ูุณุชุฎุฏู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ** (ุชู ุฅุตูุงุญู)

```javascript
// โ FIX: ุงุณุชุฎุฏุงู buildAdvancedPrompt ูู retry ูุถูุงู ุงุณุชุฎุฏุงู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ
const retryPrompt = await this.aiAgentService.buildAdvancedPrompt(
  content,
  customerData,
  companyPrompts,
  ragData,
  conversationMemory,
  hasImages,
  smartResponse,
  {
    ...messageData,
    isRetry: true
  }
);
```

**ุงูุชุฃุซูุฑ:** โ ุงูุฑุฏูุฏ ูู retry ุชุณุชุฎุฏู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ

---

## โ๏ธ ุงููุณุงุฑุงุช ุงูุชู ูุง ุชุณุชุฎุฏู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ (ูููููุง ูุง ุชุญุชุงุฌูุง)

### 4. `buildOrderConfirmationPrompt` โ๏ธ

**ุงููููุน:** `backend/services/aiAgent/responseGenerator.js` - ุงูุณุทุฑ 1084  
**ุงูุงุณุชุฎุฏุงู:** `backend/services/aiAgent/messageProcessor.js` - ุงูุณุทุฑ 1220

**ุงูุญุงูุฉ:** โ๏ธ **ูุง ูุณุชุฎุฏู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ**

**ุงูุณุจุจ:** ูุฐุง prompt ูุฎุตุต ูุชุฃููุฏ ุงูุทูุจ ููุทุ ูููุณ ุฑุฏ ุนุงู ููุนููู. ููู ูููู ุฅุถุงูุฉ ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ ูุถูุงู ุฃู ุฑุฏ ุงูุชุฃููุฏ ูุชุจุน ุงูููุงุนุฏ ุงููุฎุชุงุฑุฉ.

**ุงูุชูุตูุฉ:** โ **ูููุตุญ ุจุฅุถุงูุฉ ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ** ูุฃู ูุฐุง ุฑุฏ ูุฑุณู ููุนููู ููุฌุจ ุฃู ูุชุจุน ุงูููุงุนุฏ ุงููุฎุชุงุฑุฉ.

---

### 5. `orderProcessor.js` - `generateDataRequestResponse` โ๏ธ

**ุงููููุน:** `backend/services/aiAgent/orderProcessor.js` - ุงูุณุทุฑ 547

**ุงูุญุงูุฉ:** โ๏ธ **ูุง ูุณุชุฎุฏู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ**

**ุงูุณุจุจ:** ูุฐุง prompt ูุฎุตุต ูุทูุจ ุงูุจูุงูุงุช ุงูููููุฏุฉ ููุท. ููู ูููู ุฅุถุงูุฉ ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ ูุถูุงู ุฃู ุงูุฑุฏ ูุชุจุน ุงูููุงุนุฏ ุงููุฎุชุงุฑุฉ.

**ุงูุชูุตูุฉ:** โ **ูููุตุญ ุจุฅุถุงูุฉ ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ** ูุฃู ูุฐุง ุฑุฏ ูุฑุณู ููุนููู.

---

### 6. ูุณุงุฑุงุช ุฃุฎุฑู (ูุง ุชุญุชุงุฌ ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ)

- **`imageProcessor.js`**: ูุนุงูุฌุฉ ุงูุตูุฑ ูุชุญููููุง - ูุง ูุญุชุงุฌ ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ
- **`contextManager.js`**: ุชุญููู ุงูููุฉ - ูุง ูุญุชุงุฌ ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ
- **`intentAnalyzer.js`**: ุชุญููู ุงูููุฉ - ูุง ูุญุชุงุฌ ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ

---

## ๐ ููุฎุต ุงููุญุต

### โ ุงููุณุงุฑุงุช ุงูุชู ุชุณุชุฎุฏู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ:

1. **ุงููุณุงุฑ ุงูุฑุฆูุณู** (`buildAdvancedPrompt`) - โ
2. **ุงููุณุงุฑ ุงูุฃุณุงุณู** (`buildPrompt`) - โ
3. **ูุณุงุฑ Retry** (`buildAdvancedPrompt` ูู retry) - โ

### โ๏ธ ุงููุณุงุฑุงุช ุงูุชู ูุง ุชุณุชุฎุฏู ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ (ูููุตุญ ุจุฅุถุงูุชูุง):

4. **`buildOrderConfirmationPrompt`** - โ๏ธ (ุฑุฏ ูุฑุณู ููุนููู)
5. **`generateDataRequestResponse`** ูู `orderProcessor.js` - โ๏ธ (ุฑุฏ ูุฑุณู ููุนููู)

### โ ุงููุณุงุฑุงุช ุงูุชู ูุง ุชุญุชุงุฌ ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ:

- ูุณุงุฑุงุช ุชุญููู ุงูููุฉ ูุงูุตูุฑ (ูุง ุชููุฏ ุฑุฏูุฏ ููุนููุงุก)

---

## ๐ฏ ุงูุชูุตูุงุช

### 1. ุฅุถุงูุฉ ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ ุฅูู `buildOrderConfirmationPrompt`

**ุงูุณุจุจ:** ุฑุฏ ุชุฃููุฏ ุงูุทูุจ ูุฑุณู ููุนููู ููุฌุจ ุฃู ูุชุจุน ุงูููุงุนุฏ ุงููุฎุชุงุฑุฉ (ูุซู ุทูู ุงูุฑุฏ).

**ุงูุชุนุฏูู ุงููุทููุจ:**
```javascript
// ูู buildOrderConfirmationPrompt
// ุจุนุฏ ุฅุถุงูุฉ personality prompt
if (companyPrompts.responseRules) {
  try {
    const rules = typeof companyPrompts.responseRules === 'string' 
      ? JSON.parse(companyPrompts.responseRules) 
      : companyPrompts.responseRules;
    prompt += buildPromptFromRules(rules);
  } catch (e) {
    prompt += buildPromptFromRules(getDefaultRules());
  }
} else {
  prompt += buildPromptFromRules(getDefaultRules());
}
```

### 2. ุฅุถุงูุฉ ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ ุฅูู `generateDataRequestResponse`

**ุงูุณุจุจ:** ุฑุฏ ุทูุจ ุงูุจูุงูุงุช ูุฑุณู ููุนููู ููุฌุจ ุฃู ูุชุจุน ุงูููุงุนุฏ ุงููุฎุชุงุฑุฉ.

**ุงูุชุนุฏูู ุงููุทููุจ:**
- ุชูุฑูุฑ `companyPrompts` ุฅูู `generateDataRequestResponse`
- ุฅุถุงูุฉ ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ ููู prompt

---

## ๐ ุงูุฎูุงุตุฉ

### โ ุงูุฅุฌุงุจุฉ ุนูู ุงูุณุคุงู:

**ูุนูุ ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ ุจุตูุฉ ุนุงูุฉ ุชุฏุฎู ูู ุจูุงุก ุงูุฑุฏ** ูู ุงููุณุงุฑุงุช ุงูุฑุฆูุณูุฉ:

- โ ุงููุณุงุฑ ุงูุฑุฆูุณู (`buildAdvancedPrompt`)
- โ ุงููุณุงุฑ ุงูุฃุณุงุณู (`buildPrompt`)
- โ ูุณุงุฑ Retry

### โ๏ธ ููู ููุงู ูุณุงุฑุงู ุฅุถุงููุงู ูููุตุญ ุจุฅุถุงูุฉ ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ ุฅููููุง:

- โ๏ธ `buildOrderConfirmationPrompt` (ุฑุฏ ุชุฃููุฏ ุงูุทูุจ)
- โ๏ธ `generateDataRequestResponse` (ุฑุฏ ุทูุจ ุงูุจูุงูุงุช)

---

**ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุฑูุฑ ุจูุงุณุทุฉ:** AI Assistant  
**ุงูุชุงุฑูุฎ:** 2025-11-28

