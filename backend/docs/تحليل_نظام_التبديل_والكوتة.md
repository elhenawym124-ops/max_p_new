# ๐ ุชุญููู ูุธุงู ุงูุชุจุฏูู ูุงูููุชุฉ

**ุชุงุฑูุฎ ุงูุชุญููู:** $(date)  
**ุงููููุงุช ุงูููุญูุตุฉ:**
- `backend/services/aiAgent/modelManager.js`
- `backend/services/aiAgent/responseGenerator.js`

---

## ๐ ุงููุชุทูุจุงุช ุงููุทููุจุฉ

ุงููุณุชุฎุฏู ูุฑูุฏ:
1. **ุงููููุฐุฌ ูุณุชููู ุฃููุงู ูู ูู ุงูููุงุชูุญ**: ุงูููุชุฉ = ูุฌููุน ุงูููุชุฉ ูููููุฐุฌ ุงููุงุญุฏ ูู ูู ุงูููุงุชูุญ
2. **ุจุนุฏ ุฐูู ูุชุญูู ููููุฐุฌ ุชุงูู ุญุณุจ ุงูุฃููููุฉ**: ุจุนุฏ ุงุณุชููุงุฏ ุงููููุฐุฌ ุงูุฃููุ ููุชูู ูููููุฐุฌ ุงูุชุงูู

---

## ๐ ููู ูุนูู ุงููุธุงู ุญุงููุงู

### 1. ุญุณุงุจ ุงูููุชุฉ ุงูุฅุฌูุงููุฉ โ **ุตุญูุญ**

**ุงูููุฏ:**
```javascript
// modelManager.js - _calculateQuotaFromModels
// ูุฌูุน ุงูููุงุฐุฌ ูู ูู ุงูููุงุชูุญ
const allModels = await this.aggregateModelsByPriority(modelName, companyId);

// ูุญุณุจ ุงูููุชุฉ ุงูุฅุฌูุงููุฉ
for (const modelRecord of allModels) {
  totalRPM += rpmLimit;        // โ ูุฌููุน RPM ูู ูู ุงูููุงุชูุญ
  totalRPMUsed += rpmUsed;     // โ ูุฌููุน RPM ุงููุณุชุฎุฏู ูู ูู ุงูููุงุชูุญ
  totalTPM += tpmLimit;        // โ ูุฌููุน TPM ูู ูู ุงูููุงุชูุญ
  totalTPMUsed += tpmUsed;     // โ ูุฌููุน TPM ุงููุณุชุฎุฏู ูู ูู ุงูููุงุชูุญ
  totalRPD += rpdLimit;        // โ ูุฌููุน RPD ูู ูู ุงูููุงุชูุญ
  totalRPDUsed += rpdUsed;     // โ ูุฌููุน RPD ุงููุณุชุฎุฏู ูู ูู ุงูููุงุชูุญ
}

rpmPercentage = (totalRPMUsed / totalRPM) * 100;
```

**ุงูุชุญูู:**
- โ **ุตุญูุญ**: ูุญุณุจ ุงูููุชุฉ ุงูุฅุฌูุงููุฉ = ูุฌููุน ุงูููุชุฉ ูู ูู ุงูููุงุชูุญ
- โ **ูุซุงู**: ุฅุฐุง ูุงู ูุฏูู 3 ููุงุชูุญุ ูู ููุชุงุญ ูู `gemini-2.5-pro` ุจู RPM=2
  - `totalRPM = 2 + 2 + 2 = 6`
  - `totalRPMUsed = 0 + 0 + 0 = 0`
  - `rpmPercentage = 0%`

---

### 2. ุงุฎุชูุงุฑ ุงููููุฐุฌ ุญุณุจ ุงูุฃููููุฉ โ **ุตุญูุญ**

**ุงูููุฏ:**
```javascript
// modelManager.js - findBestModelByPriorityWithQuota
// 1. ุงูุญุตูู ุนูู ูุงุฆูุฉ ุงูููุงุฐุฌ ูุฑุชุจุฉ ุญุณุจ ุงูุฃููููุฉ
const supportedModels = await this.getModelsOrderedByPriority(companyId);
// ูุซุงู: ['gemini-2.5-pro', 'gemini-2.5-flash', 'gemini-1.5-pro']

// 2. ููู ูููุฐุฌ ุญุณุจ ุงูุฃููููุฉ
for (let i = 0; i < supportedModels.length; i++) {
  const modelName = supportedModels[i];
  
  // 3. ุญุณุงุจ ุงูููุชุฉ ุงูุฅุฌูุงููุฉ
  const quota = await this.calculateTotalQuota(modelName, companyId);
  
  // 4. ูุญุต ุฅุฐุง ูุงู ูุชุฌุงูุฒ 80%
  if (quota.rpmPercentage >= 80 || quota.tpmPercentage >= 80) {
    continue; // โ ุงูุชูู ูููููุฐุฌ ุงูุชุงูู
  }
  
  // 5. ุงุฎุชูุงุฑ ููุชุงุญ ูู availableModels
  const selectedModel = await this.selectBestModelByPriority(availableModelsAfterExclusion);
  
  if (selectedModel) {
    return selectedModel; // โ ุฅุฑุฌุงุน ุงููููุฐุฌ ุงููุฎุชุงุฑ
  }
}
```

**ุงูุชุญูู:**
- โ **ุตุญูุญ**: ูุจุฏุฃ ูู ุงูููุงุฐุฌ ุญุณุจ ุงูุฃููููุฉ
- โ **ุตุญูุญ**: ุฅุฐุง ูุงูุช ุงูููุชุฉ >= 80%ุ ููุชูู ูููููุฐุฌ ุงูุชุงูู
- โ **ุตุญูุญ**: ุฅุฐุง ูุงูุช ุงูููุชุฉ < 80%ุ ูุฎุชุงุฑ ููุชุงุญ ูู `availableModels`

---

### 3. Round-Robin ุจูู ุงูููุงุชูุญ โ **ุตุญูุญ**

**ุงูููุฏ:**
```javascript
// modelManager.js - selectBestModelByPriority
// โ Round-Robin ุนูู ุงูููุงุฐุฌ ูู ููุณ ุงูุฃููููุฉ
if (this.lastUsedGlobalKeyId) {
  const lastIndex = models.findIndex(m => m.keyId === this.lastUsedGlobalKeyId);
  if (lastIndex >= 0) {
    selectedIndex = (lastIndex + 1) % models.length; // โ Round-Robin
  }
}

const selectedModel = models[selectedIndex];
this.lastUsedGlobalKeyId = selectedModel.keyId; // โ ุชุญุฏูุซ ุขุฎุฑ ููุชุงุญ ูุณุชุฎุฏู
```

**ุงูุชุญูู:**
- โ **ุตุญูุญ**: ูุณุชุฎุฏู Round-Robin ุจูู ุงูููุงุชูุญ ูููุณ ุงููููุฐุฌ
- โ **ูุซุงู**: ุฅุฐุง ูุงู ูุฏูู 3 ููุงุชูุญ ูููุณ ุงููููุฐุฌ:
  - ุงูุทูุจ 1: ุงูููุชุงุญ 1
  - ุงูุทูุจ 2: ุงูููุชุงุญ 2
  - ุงูุทูุจ 3: ุงูููุชุงุญ 3
  - ุงูุทูุจ 4: ุงูููุชุงุญ 1 (ุฏูุฑุฉ ุฌุฏูุฏุฉ)

---

## โ๏ธ ุงููุดุงูู ุงูููุชุดูุฉ

### ุงููุดููุฉ 1: ุงูุชุจุฏูู ุนูุฏ 80% ูุฏ ูููู ูุจูุฑุงู โ๏ธ

**ุงููุดููุฉ:**
- ุงููุธุงู ููุชูู ูููููุฐุฌ ุงูุชุงูู ุนูุฏูุง ุชุตู ุงูููุชุฉ ุฅูู 80%
- ููู ูุฏ ูููู ููุงู ููุงุชูุญ ูุชุงุญุฉ ุฑุบู ุฃู ุงูููุชุฉ ุงูุฅุฌูุงููุฉ 80%

**ูุซุงู:**
- ูุฏูู 3 ููุงุชูุญุ ูู ููุชุงุญ ูู `gemini-2.5-pro` ุจู RPM=2
- `totalRPM = 6`
- ุฅุฐุง ุงุณุชุฎุฏูุช 5 ุทูุจุงุช (83%)ุ ุงููุธุงู ููุชูู ูููููุฐุฌ ุงูุชุงูู
- ููู ุงูููุชุงุญ ุงูุซุงูุซ ูุง ูุฒุงู ูุชุงุญุงู (0/2)

**ุงูููุฏ:**
```javascript
// ุงูุณุทุฑ 2340
if (quota.rpmPercentage >= 80 || quota.tpmPercentage >= 80) {
  console.log(`โ๏ธ [QUOTA-PRIORITY] ${modelName} ูุฑุจ ูุฎูุต (RPM: ${quota.rpmPercentage.toFixed(1)}%, TPM: ${quota.tpmPercentage.toFixed(1)}%) - ุชุฎุทู`);
  continue; // โ ููุชูู ูููููุฐุฌ ุงูุชุงูู ุฑุบู ูุฌูุฏ ููุงุชูุญ ูุชุงุญุฉ
}
```

**ุงูุชุฃุซูุฑ:**
- โ ููุฏุงู ุงูุณุนุฉ ุงููุชุงุญุฉ ูู ุงูููุงุชูุญ ุงูุฃุฎุฑู
- โ ุงูุชุจุฏูู ุงููุจูุฑ ููููุงุฐุฌ ุงูุฃุฎุฑู

---

### ุงููุดููุฉ 2: ูุง ููุฌุฏ ูุญุต ููููุงุชูุญ ุงููุฑุฏูุฉ โ๏ธ

**ุงููุดููุฉ:**
- ุงููุธุงู ููุญุต ุงูููุชุฉ ุงูุฅุฌูุงููุฉ ููุท
- ูุง ููุญุต ุฅุฐุง ูุงู ููุงู ููุงุชูุญ ูุฑุฏูุฉ ูุชุงุญุฉ

**ุงูููุฏ:**
```javascript
// ุงูุณุทุฑ 1782
if (isAvailable) {
  availableModels.push(modelRecord); // โ ูุถูู ุงูููุงุชูุญ ุงููุชุงุญุฉ
}

// ููู ูู findBestModelByPriorityWithQuota:
if (quota.rpmPercentage >= 80) {
  continue; // โ ููุชูู ูููููุฐุฌ ุงูุชุงูู ุฑุบู ูุฌูุฏ ููุงุชูุญ ูู availableModels
}
```

**ุงูุชุฃุซูุฑ:**
- โ ูุฏ ูุชู ุชุฎุทู ุงููููุฐุฌ ุฑุบู ูุฌูุฏ ููุงุชูุญ ูุชุงุญุฉ ูู `availableModels`

---

### ุงููุดููุฉ 3: Round-Robin ูุนูู ุนูู ุงูููุงุฐุฌ ุงููุชุงุญุฉ ููุท โ๏ธ

**ุงููุดููุฉ:**
- Round-Robin ูุนูู ุนูู `availableModelsAfterExclusion` ููุท
- ุฅุฐุง ูุงู ููุชุงุญ ูุงุญุฏ ูุณุชููุฏุ Round-Robin ูุชุฎุทุงู
- ููู ุงูููุชุฉ ุงูุฅุฌูุงููุฉ ูุฏ ุชููู 80% ุฑุบู ูุฌูุฏ ููุงุชูุญ ูุชุงุญุฉ

**ูุซุงู:**
- ูุฏูู 3 ููุงุชูุญุ ูู ููุชุงุญ ูู `gemini-2.5-pro` ุจู RPM=2
- ุงูููุชุงุญ 1: 2/2 (ูุณุชููุฏ)
- ุงูููุชุงุญ 2: 2/2 (ูุณุชููุฏ)
- ุงูููุชุงุญ 3: 0/2 (ูุชุงุญ)
- `totalRPM = 6`, `totalRPMUsed = 4`, `rpmPercentage = 66%`
- ุงููุธุงู ูุณุชูุฑ ูู ุงุณุชุฎุฏุงู ุงูููุชุงุญ 3 โ
- ููู ุฅุฐุง ูุตู `totalRPMUsed = 5` (83%)ุ ุงููุธุงู ููุชูู ูููููุฐุฌ ุงูุชุงูู โ

---

## โ ูุง ูุนูู ุจุดูู ุตุญูุญ

1. โ **ุญุณุงุจ ุงูููุชุฉ ุงูุฅุฌูุงููุฉ**: ุตุญูุญ - ูุฌููุน ูู ูู ุงูููุงุชูุญ
2. โ **Round-Robin ุจูู ุงูููุงุชูุญ**: ุตุญูุญ - ููุฒุน ุงูุงุณุชุฎุฏุงู ุจูู ุงูููุงุชูุญ
3. โ **ุงูุชุจุฏูู ุญุณุจ ุงูุฃููููุฉ**: ุตุญูุญ - ูุจุฏุฃ ูู ุงูููุงุฐุฌ ุญุณุจ ุงูุฃููููุฉ
4. โ **ุชุฌููุน ุงูููุงุฐุฌ ูู ูู ุงูููุงุชูุญ**: ุตุญูุญ - ูุฌูุน ุงูููุงุฐุฌ ูู ูู ุงูููุงุชูุญ

---

## โ ูุง ูุญุชุงุฌ ุชุญุณูู

1. โ **ุงูุชุจุฏูู ุนูุฏ 80%**: ูุฌุจ ูุญุต `availableModels` ูุจู ุงูุชุจุฏูู
2. โ **ูุญุต ุงูููุงุชูุญ ุงููุฑุฏูุฉ**: ูุฌุจ ุงูุชุฃูุฏ ูู ูุฌูุฏ ููุงุชูุญ ูุชุงุญุฉ ูุจู ุงูุชุจุฏูู
3. โ **ุงูุชุจุฏูู ุงููุจูุฑ**: ูุฌุจ ุงุณุชุฎุฏุงู ุฌููุน ุงูููุงุชูุญ ุงููุชุงุญุฉ ูุจู ุงูุชุจุฏูู

---

## ๐ฏ ุงูุญููู ุงูููุชุฑุญุฉ

### ุงูุญู 1: ูุญุต availableModels ูุจู ุงูุชุจุฏูู

```javascript
// ุจุฏูุงู ูู:
if (quota.rpmPercentage >= 80 || quota.tpmPercentage >= 80) {
  continue;
}

// ุงุณุชุฎุฏู:
if (quota.rpmPercentage >= 80 || quota.tpmPercentage >= 80) {
  // โ ูุญุต ุฅุฐุง ูุงู ููุงู ููุงุชูุญ ูุชุงุญุฉ
  if (quota.availableModels.length === 0) {
    continue; // ูุง ุชูุฌุฏ ููุงุชูุญ ูุชุงุญุฉ - ุงูุชูู ูููููุฐุฌ ุงูุชุงูู
  }
  // โ ุฅุฐุง ูุงู ููุงู ููุงุชูุญ ูุชุงุญุฉุ ุงุณุชูุฑ ูู ุงุณุชุฎุฏุงููุง
}
```

### ุงูุญู 2: ุงุณุชุฎุฏุงู availableModels ุจุฏูุงู ูู ุงูููุชุฉ ุงูุฅุฌูุงููุฉ

```javascript
// ุจุฏูุงู ูู ูุญุต ุงูููุชุฉ ุงูุฅุฌูุงููุฉ ููุท:
if (quota.rpmPercentage >= 80) {
  continue;
}

// ุงุณุชุฎุฏู ูุญุต ุงูููุงุชูุญ ุงููุชุงุญุฉ:
if (availableModelsAfterExclusion.length === 0) {
  continue; // ูุง ุชูุฌุฏ ููุงุชูุญ ูุชุงุญุฉ - ุงูุชูู ูููููุฐุฌ ุงูุชุงูู
}
// โ ุฅุฐุง ูุงู ููุงู ููุงุชูุญ ูุชุงุญุฉุ ุงุณุชูุฑ ูู ุงุณุชุฎุฏุงููุง
```

---

## ๐ ุงูุฎูุงุตุฉ

### ูุง ูุนูู ุจุดูู ุตุญูุญ:
- โ ุญุณุงุจ ุงูููุชุฉ ุงูุฅุฌูุงููุฉ = ูุฌููุน ูู ูู ุงูููุงุชูุญ
- โ Round-Robin ุจูู ุงูููุงุชูุญ ูููุณ ุงููููุฐุฌ
- โ ุงูุชุจุฏูู ุญุณุจ ุงูุฃููููุฉ

### ูุง ูุญุชุงุฌ ุชุญุณูู:
- โ๏ธ ุงูุชุจุฏูู ุนูุฏ 80% ูุฏ ูููู ูุจูุฑุงู
- โ๏ธ ูุฌุจ ูุญุต `availableModels` ูุจู ุงูุชุจุฏูู
- โ๏ธ ูุฌุจ ุงุณุชุฎุฏุงู ุฌููุน ุงูููุงุชูุญ ุงููุชุงุญุฉ ูุจู ุงูุชุจุฏูู

### ุงูุชูุตูุฉ:
ูุฌุจ ุชุนุฏูู ููุทู ุงูุชุจุฏูู ููุญุต `availableModels` ูุจู ุงูุชุจุฏูู ูููููุฐุฌ ุงูุชุงููุ ูุถูุงู ุงุณุชุฎุฏุงู ุฌููุน ุงูููุงุชูุญ ุงููุชุงุญุฉ ุฃููุงู.

---

**ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุฑูุฑ ุจูุงุณุทุฉ:** AI Assistant  
**ุงูุชุงุฑูุฎ:** $(date)

