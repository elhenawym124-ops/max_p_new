# ๐ ุชุญููู ูุดููุฉ 429 ูู ุงููููุฐุฌ ุงูุจุฏูู

**ุชุงุฑูุฎ ุงูุชุญููู:** $(date)  
**ุงูุฎุทุฃ:**
```
โ ุฎุทุฃ: ูุดู ุงููููุฐุฌ ุงูุจุฏูู ุจุนุฏ ุฎุทุฃ 503: [429 Too Many Requests] 
ุงููููุฐุฌ: gemini-2.5-flash
```

---

## ๐ ุงูุณููุงุฑูู

1. โ ุงููููุฐุฌ ุงูุฃุณุงุณู ูุดู ุจู **503** (Service Unavailable)
2. โ ุงููุธุงู ุญุงูู ุงููููุฐุฌ ุงูุจุฏูู **gemini-2.5-flash** โ ูุดู ุจู **429** (Quota Exceeded)
3. โ ุงููุธุงู ุญุงูู ุงูุจุญุซ ุนู ูููุฐุฌ ุซุงูุซ โ **ูู ูุฌุฏ** ุฃู **ูุดู ุฃูุถุงู**
4. โ ุงููุชูุฌุฉ: **ุงููุธุงู ุตุงูุช** - ูู ูุชู ุฅุฑุณุงู ุฑุฏ ููุนููู

---

## ๐ ุชุญููู ุงูููุฏ

### 1. ูุนุงูุฌุฉ ุฎุทุฃ 429 ูู ุงููููุฐุฌ ุงูุจุฏูู

**ุงูููุฏ:**
```javascript
// responseGenerator.js - ุงูุณุทุฑ 1868-1908
if (is429Error) {
  // โ ุชุญุฏูุฏ ุงููููุฐุฌ ุงูุจุฏูู ููุณุชููุฏ
  await this.aiAgentService.markModelAsExhaustedFrom429(modelName, quotaValue, companyId);
  
  // โ ุฅุถุงูุฉ ุงููููุฐุฌ ุงูุจุฏูู ุฅูู triedModels
  triedModels.add(backupModel.model);
  
  // โ ุงูุจุญุซ ุนู ูููุฐุฌ ุซุงูุซ
  const excludeModelsArray = Array.from(triedModels);
  const secondBackupModel = await this.aiAgentService.findNextAvailableModel(companyId, excludeModelsArray);
  
  if (secondBackupModel && 
      secondBackupModel.model !== backupModel.model && 
      !triedModels.has(secondBackupModel.model)) {
    // โ ูุญุงููุฉ ุงุณุชุฎุฏุงู ุงููููุฐุฌ ุงูุซุงูุซ
  } else {
    // โ ูู ูุฌุฏ ูููุฐุฌ ุซุงูุซ
    console.error('โ [503-FALLBACK-429] No second backup model available or all models exhausted');
  }
}
```

---

## โ๏ธ ุงููุดุงูู ุงูููุชุดูุฉ

### ุงููุดููุฉ 1: markModelAsExhaustedFrom429 ูุณุชุซูู ุงููููุฐุฌ ุจุงููุงูู โ

**ุงูููุฏ:**
```javascript
// modelManager.js - ุงูุณุทุฑ 652
this.exhaustedModelsCache.add(modelName); // โ ูุถูู ุงููููุฐุฌ ุจุงููุงูู
```

**ุงููุดููุฉ:**
- ุนูุฏ ูุดู `gemini-2.5-flash` ูู ููุชุงุญ ูุงุญุฏุ ูุชู ุฅุถุงูุฉ `gemini-2.5-flash` ุจุงููุงูู ุฅูู `exhaustedModelsCache`
- ูุฐุง ูุนูู ุฃู ุฌููุน ุงูููุงุชูุญ ูููุณ ุงููููุฐุฌ ูุชู ุงุณุชุซูุงุคูุง
- ููู ูุฏ ูููู ููุงู ููุงุชูุญ ุฃุฎุฑู ูููุณ ุงููููุฐุฌ ูุชุงุญุฉ!

**ูุซุงู:**
- ูุฏูู 3 ููุงุชูุญุ ูู ููุชุงุญ ูู `gemini-2.5-flash`
- ุงูููุชุงุญ 1: `gemini-2.5-flash` ูุดู ุจู 429
- ุงููุธุงู ูุถูู `gemini-2.5-flash` ุฅูู `exhaustedModelsCache`
- ุงูููุชุงุญ 2 ู 3: `gemini-2.5-flash` ูุชุงุญุงู ููู ูุชู ุงุณุชุซูุงุคููุง! โ

---

### ุงููุดููุฉ 2: findBestModelByPriorityWithQuota ููุญุต exhaustedModelsCache โ

**ุงูููุฏ:**
```javascript
// modelManager.js - ุงูุณุทุฑ 2326
if (this.exhaustedModelsCache && this.exhaustedModelsCache.has(modelName)) {
  console.log(`๐ซ [QUOTA-PRIORITY] ${modelName} - ูู exhaustedModelsCache - ุชุฎุทู`);
  continue; // โ ูุชุฎุทู ุงููููุฐุฌ ุจุงููุงูู
}
```

**ุงููุดููุฉ:**
- ุฅุฐุง ูุงู ุงููููุฐุฌ ูู `exhaustedModelsCache`ุ ูุชู ุชุฎุทูู ุจุงููุงูู
- ููู ูุฏ ูููู ููุงู ููุงุชูุญ ุฃุฎุฑู ูููุณ ุงููููุฐุฌ ูุชุงุญุฉ!

---

### ุงููุดููุฉ 3: ูุง ููุฌุฏ ูุญุต ููููุงุชูุญ ุงููุฑุฏูุฉ โ๏ธ

**ุงููุดููุฉ:**
- ุงููุธุงู ููุญุต ุงููููุฐุฌ ุจุงููุงููุ ูููุณ ุงูููุชุงุญ ุงููุญุฏุฏ
- ูุฌุจ ุฃู ููุญุต ุงูููุชุงุญ ุงููุญุฏุฏ ููุทุ ูููุณ ุงููููุฐุฌ ุจุงููุงูู

---

## ๐ฏ ุงูุญููู ุงูููุชุฑุญุฉ

### ุงูุญู 1: ุชุญุณูู markModelAsExhaustedFrom429

**ุงููุดููุฉ ุงูุญุงููุฉ:**
```javascript
// โ ูุถูู ุงููููุฐุฌ ุจุงููุงูู
this.exhaustedModelsCache.add(modelName);
```

**ุงูุญู ุงูููุชุฑุญ:**
```javascript
// โ ุฅุถุงูุฉ ุงูููุชุงุญ ุงููุญุฏุฏ ููุทุ ูููุณ ุงููููุฐุฌ ุจุงููุงูู
// ุงุณุชุฎุฏุงู Map: modelName โ Set<keyId>
if (!this.exhaustedKeysCache) {
  this.exhaustedKeysCache = new Map();
}
if (!this.exhaustedKeysCache.has(modelName)) {
  this.exhaustedKeysCache.set(modelName, new Set());
}
this.exhaustedKeysCache.get(modelName).add(keyId); // โ ุงูููุชุงุญ ุงููุญุฏุฏ ููุท
```

---

### ุงูุญู 2: ุชุญุณูู findBestModelByPriorityWithQuota

**ุงููุดููุฉ ุงูุญุงููุฉ:**
```javascript
// โ ูุชุฎุทู ุงููููุฐุฌ ุจุงููุงูู
if (this.exhaustedModelsCache && this.exhaustedModelsCache.has(modelName)) {
  continue;
}
```

**ุงูุญู ุงูููุชุฑุญ:**
```javascript
// โ ูุญุต ุงูููุงุชูุญ ุงููุฑุฏูุฉ ููุท
// ูุง ุชุชุฎุทู ุงููููุฐุฌ ุจุงููุงููุ ุจู ูุญุต ุงูููุงุชูุญ ุงููุฑุฏูุฉ
// (ุงูููุฏ ุงูุญุงูู ูู availableModelsAfterExclusion ููุญุต ุงูููุงุชูุญ ุงููุฑุฏูุฉ ุจุงููุนู)
```

---

### ุงูุญู 3: ุชุญุณูู ุงุณุชุซูุงุก ุงูููุงุฐุฌ

**ุงููุดููุฉ ุงูุญุงููุฉ:**
- `exhaustedModelsCache` ูุณุชุซูู ุงููููุฐุฌ ุจุงููุงูู
- ูุฌุจ ุฃู ูุณุชุซูู ุงูููุชุงุญ ุงููุญุฏุฏ ููุท

**ุงูุญู ุงูููุชุฑุญ:**
```javascript
// โ ุงุณุชุฎุฏุงู excludedModels ุจุฏูุงู ูู exhaustedModelsCache
// excludedModels ููุญุต ุงูููุชุงุญ ุงููุญุฏุฏ ููุท
// (ุงูููุฏ ุงูุญุงูู ูุณุชุฎุฏู excludedModels ุจุงููุนู ูู availableModelsAfterExclusion)
```

---

## ๐ ุงูุฎูุงุตุฉ

### ุงููุดููุฉ ุงูุฑุฆูุณูุฉ:
1. โ `markModelAsExhaustedFrom429` ูุณุชุซูู ุงููููุฐุฌ ุจุงููุงูู ุจุฏูุงู ูู ุงูููุชุงุญ ุงููุญุฏุฏ
2. โ `findBestModelByPriorityWithQuota` ูุชุฎุทู ุงููููุฐุฌ ุจุงููุงูู ุฅุฐุง ูุงู ูู `exhaustedModelsCache`
3. โ ุงููุชูุฌุฉ: ูุง ูููู ุงุณุชุฎุฏุงู ููุงุชูุญ ุฃุฎุฑู ูููุณ ุงููููุฐุฌ ุญุชู ูู ูุงูุช ูุชุงุญุฉ

### ุงูุญู:
1. โ ุงุณุชุฎุฏุงู `excludedModels` ุจุฏูุงู ูู `exhaustedModelsCache` ููุงุณุชุซูุงุก ุงูุฏููู
2. โ ุฅุฒุงูุฉ ูุญุต `exhaustedModelsCache` ูู `findBestModelByPriorityWithQuota`
3. โ ุงูุงุนุชูุงุฏ ุนูู `availableModelsAfterExclusion` ุงูุฐู ููุญุต ุงูููุงุชูุญ ุงููุฑุฏูุฉ

---

**ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุฑูุฑ ุจูุงุณุทุฉ:** AI Assistant  
**ุงูุชุงุฑูุฎ:** $(date)

