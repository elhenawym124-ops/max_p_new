# ๐ ุดุฑุญ ูุธุงู ุงุฎุชูุงุฑ ุงูููุงุชูุญ ุงูุญุงูู

## ๐ ููู ูุนูู ุงููุธุงู ุญุงููุงูุ

### ุงูุณููุงุฑูู 1: ุดุฑูุฉ **ูุน** ููุงุชูุญ ุฎุงุตุฉ ุจูุง

**ุงูุญุงูุฉ:** ุงูุดุฑูุฉ ูุฏููุง ููุงุชูุญ Gemini ุฎุงุตุฉ (`useCentralKeys = false`)

#### ุงูุฎุทูุงุช:
1. โ **ุงูุจุญุซ ูู ููุงุชูุญ ุงูุดุฑูุฉ ุฃููุงู**
   - ูุจุญุซ ุนู ุฃูู ููุชุงุญ ูุดุท ููุดุฑูุฉ
   - ุฅุฐุง ูู ูุฌุฏ ููุชุงุญ ูุดุทุ ูุญุงูู ุชูุนูู ุฃูู ููุชุงุญ ูุชุงุญ ุชููุงุฆูุงู

2. โ **ุงูุจุญุซ ุนู ูููุฐุฌ ูุชุงุญ**
   - ูุจุญุซ ุนู ุฃูุถู ูููุฐุฌ ูุชุงุญ ูู ุงูููุชุงุญ ุงููุดุท
   - ุฅุฐุง ูู ูุฌุฏุ ูุจุญุซ ุนู ูููุฐุฌ ุขุฎุฑ ูู ููุณ ุงูููุชุงุญ
   - ุฅุฐุง ูู ูุฌุฏุ ูุจุญุซ ูู ููุงุชูุญ ุฃุฎุฑู ููุดุฑูุฉ

3. โ **Fallback ุฅูู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ** (ุฅุฐุง ูู ุชุฌุฏ ุฃู ููุงุชูุญ ุดุฑูุฉ)
   - ุฅุฐุง ูู ุชูุฌุฏ **ุฃู** ููุงุชูุญ ุดุฑูุฉ ูุดุทุฉ ุฃู ูุชุงุญุฉ
   - ูุจุญุซ ูู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ ูุจุฏูู
   - **โ ุงูุดุฑูุฉ ุจุฏูู ููุงุชูุญ โ ุชุณุชุฎุฏู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ**

---

### ุงูุณููุงุฑูู 2: ุดุฑูุฉ **ุจุฏูู** ููุงุชูุญ ุฎุงุตุฉ

**ุงูุญุงูุฉ:** ุงูุดุฑูุฉ ูุง ูุฏููุง ููุงุชูุญ Gemini (`useCentralKeys = false`)

#### ุงูุฎุทูุงุช:
1. โ **ูุง ุชูุฌุฏ ููุงุชูุญ ุดุฑูุฉ**
   - ุงููุธุงู ูุง ูุฌุฏ ุฃู ููุงุชูุญ ููุดุฑูุฉ
   - ูุญุงูู ุชูุนูู ููุชุงุญ (ูุดู - ูุง ุชูุฌุฏ ููุงุชูุญ)

2. โ **Fallback ุฅูู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ**
   - ูุจุญุซ ุชููุงุฆูุงู ูู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ
   - ูุณุชุฎุฏู ุงูููุชุงุญ ุงููุฑูุฒู ุฅุฐุง ูุงู ูุชุงุญุงู
   - **โ ุงูุดุฑูุฉ ุจุฏูู ููุงุชูุญ โ ุชุณุชุฎุฏู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ**

---

### ุงูุณููุงุฑูู 3: ุดุฑูุฉ ููุงุชูุญูุง **ูุณุชููุฐุฉ**

**ุงูุญุงูุฉ:** ุฌููุน ููุงุชูุญ ุงูุดุฑูุฉ ุงุณุชูุฎุฏูุช ุจุงููุงูู (ูุณุชููุฐุฉ)

#### ุงูุฎุทูุงุช:
1. โ๏ธ **ููุงุชูุญ ุงูุดุฑูุฉ ูุณุชููุฐุฉ**
   - ูุจุญุซ ูู ุฌููุน ููุงุชูุญ ุงูุดุฑูุฉ
   - ูุง ูุฌุฏ ุฃู ูููุฐุฌ ูุชุงุญ

2. โ **Fallback ุฅูู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ**
   - ูุจุญุซ ูู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ
   - ูุณุชุฎุฏู ุงูููุชุงุญ ุงููุฑูุฒู ูุจุฏูู
   - **โ ุงูุดุฑูุฉ ููุงุชูุญูุง ูุณุชููุฐุฉ โ ุชุณุชุฎุฏู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ**

---

### ุงูุณููุงุฑูู 4: ุดุฑูุฉ ุชุณุชุฎุฏู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ ููุท

**ุงูุญุงูุฉ:** ุงูุดุฑูุฉ ูุฏููุง `useCentralKeys = true`

#### ุงูุฎุทูุงุช:
1. โ **ุงูุจุญุซ ูู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ ููุท**
   - ูุจุญุซ ูุจุงุดุฑุฉ ูู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ
   - ูุง ูุจุญุซ ูู ููุงุชูุญ ุงูุดุฑูุฉ

2. โ๏ธ **ุฅุฐุง ูุงูุช ุงูููุงุชูุญ ุงููุฑูุฒูุฉ ูุณุชููุฐุฉ**
   - ุญุงููุงู: ูุฑุฌุน `null` (ูุง ููุฌุฏ fallback)
   - **โ ุงููุดููุฉ: ูุง ููุฌุฏ fallback ููููุงุชูุญ ุงููุฑูุฒูุฉ**

---

## ๐ ููุฎุต ุงูุญุงูุงุช:

| ุงูุญุงูุฉ | ุงูุดุฑูุฉ ูุฏููุง ููุงุชูุญุ | ุงูููุงุชูุญ ูุณุชููุฐุฉุ | useCentralKeys | ุงููุชูุฌุฉ |
|--------|---------------------|------------------|----------------|---------|
| 1 | โ ูุนู | โ ูุง | false | โ ูุณุชุฎุฏู ููุงุชูุญ ุงูุดุฑูุฉ |
| 2 | โ ูุง | - | false | โ ูุณุชุฎุฏู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ (fallback) |
| 3 | โ ูุนู | โ ูุนู | false | โ ูุณุชุฎุฏู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ (fallback) |
| 4 | - | - | true | โ ูุณุชุฎุฏู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ ููุท |
| 5 | - | - | true (ูุณุชููุฐุฉ) | โ ูุฑุฌุน null (ูุง ููุฌุฏ fallback) |

---

## โ ุงูุฅุฌุงุจุฉ ุนูู ุณุคุงูู:

### ุณุคุงู: ุงูุดุฑูุฉ ุงูุชู **ููุณ ูุฏููุง ููุงุชูุญ**ุ

**ุงูุฌูุงุจ:** โ **ูุนูุ ุณุชุณุชุฎุฏู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ ุชููุงุฆูุงู**
- ุงููุธุงู ูุจุญุซ ูู ููุงุชูุญ ุงูุดุฑูุฉ ุฃููุงู
- ุฅุฐุง ูู ูุฌุฏ ุฃู ููุงุชูุญุ ูุจุญุซ ูู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ ูู fallback
- **โ ูุนูู ุจุดูู ุตุญูุญ**

---

### ุณุคุงู: ุงูุดุฑูุฉ ุงูุชู **ููุงุชูุญูุง ูุณุชููุฐุฉ**ุ

**ุงูุฌูุงุจ:** โ **ูุนูุ ุณุชุณุชุฎุฏู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ ุชููุงุฆูุงู**
- ุงููุธุงู ูุจุญุซ ูู ุฌููุน ููุงุชูุญ ุงูุดุฑูุฉ
- ุฅุฐุง ูุงูุช ุฌููุนูุง ูุณุชููุฐุฉุ ูุจุญุซ ูู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ ูู fallback
- **โ ูุนูู ุจุดูู ุตุญูุญ**

---

## โ๏ธ ููุงุญุธุฉ ูููุฉ:

### ุงููุดููุฉ ุงููุญุชููุฉ:

ุฅุฐุง ูุงูุช ุงูุดุฑูุฉ ูุฏููุง `useCentralKeys = true` ูุงูููุงุชูุญ ุงููุฑูุฒูุฉ ูุณุชููุฐุฉ:
- ุญุงููุงู: ุงููุธุงู ูุฑุฌุน `null`
- **โ ูุง ููุฌุฏ fallback**

### ุงูุญู ุงูููุชุฑุญ:

ูููู ุฅุถุงูุฉ fallback ููููุงุชูุญ ุงููุฑูุฒูุฉ (ุงูุจุญุซ ูู ููุงุชูุญ ุงูุดุฑูุฉ ุฅุฐุง ูุงูุช ุงูููุงุชูุญ ุงููุฑูุฒูุฉ ูุณุชููุฐุฉ).

---

## ๐ ุงูููุฏ ุงูุญุงูู:

### ูู `aiAgentService.js` - ุฏุงูุฉ `getActiveGeminiKey`:

```javascript
// 1. ุฅุฐุง useCentralKeys = true โ ุงุณุชุฎุฏุงู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ ููุท
if (useCentralKeys) {
  const centralKey = await this.findActiveCentralKey();
  if (centralKey) {
    // ุงุณุชุฎุฏุงู ุงูููุชุงุญ ุงููุฑูุฒู
    return centralKey;
  }
  // โ ูุง ููุฌุฏ fallback ููุง
}

// 2. ุงูุจุญุซ ูู ููุงุชูุญ ุงูุดุฑูุฉ
const activeKey = await this.findActiveCompanyKey(companyId);

if (!activeKey) {
  // โ Fallback: ุงุณุชุฎุฏุงู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ
  if (!useCentralKeys) {
    const centralKey = await this.findActiveCentralKey();
    return centralKey; // โ ูุนูู ูุจุฏูู
  }
}
```

---

## โ ุงูุฎูุงุตุฉ:

**ูุนูุ ุงููุธุงู ูุนูู ุจุดูู ุตุญูุญ:**
- โ ุงูุดุฑูุงุช ุจุฏูู ููุงุชูุญ โ ุชุณุชุฎุฏู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ
- โ ุงูุดุฑูุงุช ุจููุงุชูุญ ูุณุชููุฐุฉ โ ุชุณุชุฎุฏู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ
- โ๏ธ ุงูุดุฑูุงุช ุงูุชู ุชุณุชุฎุฏู ุงูููุงุชูุญ ุงููุฑูุฒูุฉ ููุท โ ูุง ููุฌุฏ fallback ุฅุฐุง ูุงูุช ูุณุชููุฐุฉ

---

**ุงูุชุงุฑูุฎ:** ุงูุขู  
**ุงูุญุงูุฉ:** โ **ุงููุธุงู ูุนูู ุจุดูู ุตุญูุญ ูุน fallback ููููุงุชูุญ ุงููุฑูุฒูุฉ**

